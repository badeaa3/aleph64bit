      SUBROUTINE E4FIND(IERR)
C----------------------------------------------------------------------
C!  - R2 ESTIMATOR CALCULATION : GIVE 3X4 CENTERED STOREYS
C!
C!    AUTHOR  : D. PALLIN
C!    MODIFIED:
C!
C!
C?
C!======================================================================
#ifndef DOC
#include "e4com0.h"
#include "e4com1.h"
#include "rlunit.h"
#include "rflags.h"
#include "rparac.h"
      DIMENSION APOIN(3),PARAM(6)
      INTEGER EFNDMD,EFNDSC
      EXTERNAL EFNDMD,EFNDSC,FRACST
C
      IERR=0
      CALL VZERO(XTOW,NETRA*NTOWMX*3)
      DO 1 I=1,3
      A(I)=0
      B(I)=0
      C(I)=0
 1    D(I)=0
CXX ENTRY POINT DETERMINATION   (PARAM(1..3)) AND COS DIRECTORS
CXX OF THE EXTRAPOLED LINE AT THIS POINT(PARAM(4..6))
C
      CALL E4XYZ0(PARAM,IERR)
      IF ( IERR.NE.0) THEN
           IERR = - IERR
           RETURN
      ENDIF
C
CXX WE REACH CALO IN STACK 1(ALWAYS!) SO XTOW(ITRCL,1,I) CORRESPOND
CXX TO THE ENTRY POINT IN CALO
      NTOW(ITRCL)=1
      KSINT=1
      INDI=1
      DO 2 I=1,3
      DROITE(ITRCL,I)=PARAM(I+3)
      XTOW(ITRCL,NTOW(ITRCL),I)=PARAM(I)
 2    CONTINUE
      IF(DROITE(ITRCL,1).EQ.0.)THEN
           IERR=1
           CALL RERROR('E4FIND',-1,'DROITE(ITRCL,1)=0.!!!')
           RETURN
      ENDIF
C
CXX EQUATIONS PARAMETERS  A B C D (1,2)
C   EQ DTE (Y-Y0)/CY=(Z-Z0)/CZ=(X-X0)/CX ==> 2 EQ: F(X,Y)=0 G(Z,X)=0
      A(1)=DROITE(ITRCL,2)/DROITE(ITRCL,1)
      B(1)=-1
      C(1)=0
      D(1)=XTOW(ITRCL,1,2)-A(1)*XTOW(ITRCL,1,1)
      A(2)=DROITE(ITRCL,3)/DROITE(ITRCL,1)
      B(2)=0
      C(2)=-1
      D(2)=XTOW(ITRCL,1,3)-A(2)*XTOW(ITRCL,1,1)
C
CXX   WHAT IS THE NEXT PLAN TO INTERSECT ?
CXX   INDI=1 WE SHOULD INTERSECT WITH LAST PLAN  STACK KSINT
CXX   INDI=2 WE SHOULD INTERSECT WITH FIRST PLAN STACK KSINT
CXX   INDI=3 OVERLAP ZONE(WE STOP AT THE END OF BARREL OR START
CXX          AT THE ENTRANCE IN EC
CXX   INDI=4 NO MORE INTERSECTION WITH STACKS CALO
C
 40   IF(INDI.NE.3)THEN
        KSINT=KSINT+(INDI-1)
        IF(KSINT.GT.3)THEN
                    INDI=4
                    GOTO 30
                    ENDIF
        DO 3 I=1,3
 3      APOIN(I)=XTOW(ITRCL,NTOW(ITRCL),I)
        ISUB=EFNDSC(APOIN)
        IMOD=EFNDMD(ISUB,APOIN)
      ELSE
C       WE JUMP (!) FROM BARREL TO ENDCAP
        KSINT=1
        INDI=2
        ISUB=ISUB2
      ENDIF
      SK=FLOAT(KSINT)+FRACST(KSINT,INDI)
C
      JFIRST=0
 10   CONTINUE
      IF(IGOT.EQ.3)THEN
C       CORR 20/07/90 FIRST PLAN OUTSIDE BARREL
C       WE JUMP (!) FROM BARREL TO ENDCAP
        KSINT=1
        INDI=2
        ISUB=ISUB2
        SK=FLOAT(KSINT)+FRACST(KSINT,INDI)
      ENDIF
      JFIRST=JFIRST+1
      IF(JFIRST.GT.100)THEN
        IERR=1
        RETURN
      ENDIF
      A(3)=0
      B(3)=0
      C(3)=0
      D(3)=0
CXX WE FIND THE EQ OF THE CONSIDERED PLAN= EITHER ENTRY, OUTER PLAN OF
CXX STACK KSINT, OR EDGE PLANOF BARREL IF NECESSAIRY
      IF(INDI.NE.3)THEN
                   CALL E4GTPL(A(3),B(3),C(3),D(3),ISUB,IMOD,SK)
                   ELSE
                   CALL E4GTBR(A(3),B(3),C(3),D(3))
                   ENDIF
CXX WE INTERSECT  PLAN WITH STRAIGHT LINE
      CALL E4RES3(A,B,C,D,XI,YI,ZI,IERROR)
      IF(JDBDRF(JULEC).GT.8)
     &WRITE(LDEBRL,*)'XI YI ZI IERR',XI,YI,ZI,IERROR
CXX WE CHECK IF WE ARE OUT OF CONSIDERED VOLUME
CXX IF OK WE GO TO NEXT PLAN
CXX IF NOT WE INTERSECT WITH  PLAN OF THIS NEW VOLUME
CXX IF OVERLAP REGION WE INTERSECT WITH THE EDGE PLAN
CXX IF ENDCAP REGION  SPECAL TEST WHEN TRACK REACH TOP PLAN OF EC(E4FNEC
C
      CALL E4TSTL(IGOT)
      IF(JDBDRF(JULEC).GT.8)
     &WRITE(LDEBRL,*)'IGOT',IGOT
      GOTO(10,20,20)IGOT
C
 20   IF(ISUB.NE.2)CALL E4FNEC
      NTOW(ITRCL)=NTOW(ITRCL)+1
      XTOW(ITRCL,NTOW(ITRCL),1)=XI
      XTOW(ITRCL,NTOW(ITRCL),2)=YI
      XTOW(ITRCL,NTOW(ITRCL),3)=ZI
      IF(IGOT.EQ.3)THEN
        NTOW(ITRCL)=NTOW(ITRCL)+1
        XTOW(ITRCL,NTOW(ITRCL),1)=XI
        XTOW(ITRCL,NTOW(ITRCL),2)=YI
        XTOW(ITRCL,NTOW(ITRCL),3)=ZI
      ENDIF
C
      IF(INDI.NE.4)GOTO 40
 30   CALL E4FDIJ
      RETURN
      END
#endif
