      SUBROUTINE QVSTVA(ITK,PVTX,DJET,SVTX,JET,IVX)
CKEY  QVSRCH / INTERNAL
C ----------------------------------------------------------------------
C
C! Track-Jet-Vertex association
C  Author : T. MATTISON  U.A.BARCELONA/SLAC  1 DECEMBER 1992
C  Modified : I.TOMALIN  24/3/94 to also output DCHI2.
C  Modified : G.Graefe   25-MAR-1995 adapted to NanoDst
C
C  Input Arguments :
C   * ITK IS ALPHA TRACK NUMBER
C   * PVTX() IS PRIMARY VERTEX IN ALEPH COORDINATES
C   * DJET(,) IS TWO NORMALIZED JET DIRECTIONS IN ALEPH COORDINATES
C   * SVTX(,) IS TWO SECONDARY VERTICES IN TRANSLATED-ROTATED COORDINATES
C       ORIGIN AT PVTX, 3D AXIS IN DJET DIRECTIONS
C  Output Arguments :
C   * JET=1 OR 2 ACCORDING TO JET DIRECTION
C   * IVX=1 FOR PRIMARY,
C   * IVX=2 FOR SECONDARY (IN ABOVE JET)
C   * IVX=0 FOR TRACK PASSING CUTS BUT NOT CLOSE TO EITHER VERTEX
C   * IVX=-1 FOR TRACK FAILING CUTS
C  Entry point : QVSTCHI2 (DCHI2)
C   * DCHI2 IS CHI**2 FOR TRACK TO COME FROM PRIMARY VERTEX MINUS
C              CHI**2 TO COME FROM SECONDARY.
C
C ------------------------------------------------------------------------------
#ifndef DOC
      SAVE DCHI2
      REAL DCHI2
      DIMENSION PVTX(3),DJET(3,2),SVTX(3,2)
      DIMENSION EPVTX(3),ESVTX(3)
      LOGICAL QVSGTK2
#include "nancom.h"
C ------------------------------------------------------------------------------
C  IF NANO, CALL NVSTVA
C
      IF (XNANO) THEN
        CALL NVSTVA(ITK,JET,IVX)
        RETURN
      ENDIF
C
C  CHECK WHICH JET
      CALL QVSTKJ(ITK,DJET,JET)
C
C  ASSUME IT FAILS CUTS
      IVX=-1
C
C  CHECK (LOOSE) TRACK CUTS
      DKL=ABS(SVTX(3,JET))
      IF (.NOT. QVSGTK2(ITK,PVTX,DKL)) RETURN
C
C  MAKE UP SOME NOMINAL VERTEX ERRORS
      EPVTX(1)=.0050
      EPVTX(2)=.0020
      EPVTX(3)=.0050
      ESVTX(1)=.0050
      ESVTX(2)=.0050
      ESVTX(3)=.0350
C
C  GET NORMALIZED AND SIGNED IMPACT PARAMETERS
C  RELATIVE TO BOTH VERTICES
      CALL QVSIMP(ITK,PVTX,DJET(1,JET),SVTX(1,JET),EPVTX,ESVTX,
     > DXP,DZP,DTP,DXS,DZS,DTS)
C
C  NORMALIZED DISTANCE CUT
      SIGCUT=3.0
C
C  WE WON'T USE SIGN INFORMATION
      DXP=ABS(DXP)
      DZP=ABS(DZP)
      DXS=ABS(DXS)
      DZS=ABS(DZS)
C
      IF (MIN(DXP,DZP,DXS,DZS) .GT. SIGCUT) THEN
C  TRACK IS FAR FROM EVERYTHING
        IVX=0
        DCHI2 = 0.0
      ELSEIF (MIN(DZP,DZS) .GT. SIGCUT) THEN
C  FAR FROM BOTH IN Z, BUT X IS OK
        IF (DXS .LT. DXP) THEN
          IVX=2
        ELSE
          IVX=1
        ENDIF
        DCHI2 = DXP**2 - DXS**2
      ELSEIF (MIN(DXP,DXS) .GT. SIGCUT) THEN
C  FAR FROM BOTH IN X, BUT Z IS OK
        IF (DZS .LT. DZP) THEN
          IVX=2
        ELSE
          IVX=1
        ENDIF
        DCHI2 = DZP**2 - DZS**2
      ELSE
C  WITHIN SIGCUT IN BOTH X AND Z TO ONE VERTEX OR THE OTHER
C  (ALTHOUGH NOT NECESSARILY THE SAME ONE!)
C  THIS IS THE NORMAL (AND PREFERRED) PATH
C
C  CALCULATE CHI SQUARE TO BOTH VERTICES
        CHI2P=DXP**2+DZP**2
        CHI2S=DXS**2+DZS**2
C
C  ASSIGN ACCORDING TO CHI SQUARE
        IF (CHI2S .LT. CHI2P) THEN
          IVX=2
        ELSE
          IVX=1
        ENDIF
        DCHI2 = CHI2P - CHI2S
      ENDIF
C
      RETURN
C
      ENTRY QVSTCHI2 (TCHI2)
      TCHI2 = DCHI2
C
      END
#endif

