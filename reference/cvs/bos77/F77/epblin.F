#if defined(ALEPH_DEC) &&  ! defined(UNIX)
      SUBROUTINE EPBLIN(IBUF,IERR)
CD    COMMON/EPDBGC/DBUGFL
CD    LOGICAL DBUGFL
      COMMON/EPCOMM/NMUNIT,NWUNIT,NCONT,ISTART,LASTUT,LREF,LIST(350)
      EQUIVALENCE (NOUTUT,LIST(8))
      DIMENSION ILBHD(16)
      INTEGER NBITPW, NCHAPW, NBITPC, N16PW
      PARAMETER   (NBITPW=32, NCHAPW=4, NBITPC=8, N16PW=2)
CSELF,IF=CDC,IBM,UNIVAC,NORD,CRAY,CONVEX,STF77,STF77VX.
      DIMENSION IBUF(1)
CD    LABEL=1001
CD    IF(DBUGFL)  PRINT*,LABEL,ISTART
      LUN=LIST(ISTART+10)
C--SET NP (PHYS BLOCK LENGTH) = 0  AND NEW FORMAT INDICATOR
      LIST(ISTART+14)=0
      IF(LIST(ISTART+16).EQ.0) CALL EPOPEN(2,IERR)
      IF(IERR.ne.0) GOTO 20
      LIST(ISTART+16)=2
      IF(LIST(ISTART+17).LT.2)LIST(ISTART+17)=0
      MAXWDS=LIST(ISTART+1)
      MAXWDS=MAXWDS/N16PW
      IF(LIST(ISTART+33).EQ.1)THEN
C In random mode hitting EOF is return as an error.
C As disk errors are rare, assume they are End of File
       READ(LUN,ERR=20,REC=LIST(ISTART+11)+1)(IBUF(IWRD),IWRD=1,MAXWDS)
      ELSE
       READ(LUN,ERR=40,END=20)(IBUF(IWRD),IWRD=1,MAXWDS)
      ENDIF
      NB=MAXWDS*N16PW*2
      GOTO 50
C--EOF
 20   IF(LIST(ISTART+19) .EQ. 1)GOTO 30
      LIST(ISTART+19)=1
C--OPEN ERROR, CANNOT FIND FILE
 25   IERR=1
      GOTO 9999
C EOI
 30   IERR=3
      GOTO 9999
C PARITY
 40   LIST(ISTART+13)=LIST(ISTART+13)+1
      IERR=2
      GOTO 9999
C GOOD BLOCK
 50   LIST(ISTART+11)=LIST(ISTART+11) +1
CD    LABEL=1050
CD    IF(DBUGFL)PRINT*,LABEL,ISTART,(LIST(ISTART+JJJ),JJJ=11,22)
C RESET EOF FLAG
      LIST(ISTART+19)=0
      IF(LIST(ISTART+18) .EQ. 0)GOTO 70
C--HEADERLESS BLOCK
C--- IF CONTROL WORD 27 SET, SWAP BYTES IF DONE IN PREVIOUS BLOCK
      IF(LIST(ISTART+28).NE.0)  CALL BTSWAP(IBUF,NB)
      LIST(ISTART+7)=0
      LIST(ISTART+15)=0
      LIST(ISTART+18)=LIST(ISTART+18) - 1
      LIST(ISTART+14)=NB/2
      GOTO 77777
C--BLOCK WITH HEADER
 70   CONTINUE
*--- could be 32 bit header - blow 16 16-bit words to check
      CALL BLO16W(IBUF,1,ILBHD,1,16)
*--- make sure it is not 16-bit
         LIST(ISTART+28)=0
         LIST(ISTART+29)=0
         IF(LIST(ISTART+27).EQ.0)  GOTO 72
         IF(ILBHD(7).EQ.29954.AND.ILBHD(8).EQ.31280)  GOTO 72
*---    or byte swapped 16-bit
         IF(ILBHD(7).EQ.  629.AND.ILBHD(8).EQ.12410)  GOTO 71
*--- check for 32 bit - control words 7 and 8 (identical)
*     first number is 7967 = 1F1F hex and therefore invariant under
*     byte swapping, second is 19132 = 4ABC hex and is used to byte swap
      IF(ILBHD(13).EQ.7967.AND.ILBHD(15).EQ.7967)  THEN
*---  32 bit header - byte swap ?
         IF(ILBHD(14).NE.19132)  THEN
            CALL BTSWAP(IBUF,NB)
            CALL BLO16W(IBUF,1,ILBHD,1,16)
            LIST(ISTART+28)=1
         ENDIF
         IF(ILBHD(14).NE.19132.OR.ILBHD(16).NE.19132)  THEN
*--- looks like 32 bit, but is not
            IERR=22
            GOTO 9999
         ENDIF
*--- definitly 32 bit physical header
         CALL BLO32W(IBUF,1,ILBHD,1,12)
         CALL CFRIBM(ILBHD,12,2)
*--- set 32 bit ph. header
         LIST(ISTART+29)=1
         NP=ILBHD(1)
         IF(NP.LE.0) GOTO 9901
         IF(NP .GT. LIST(ISTART+1).OR.NP.GT.NB/2) GOTO 9902
         NPHL=ILBHD(2)
         IF(NPHL.LT.LIST(6).OR.NPHL.GT.NP)  THEN
            IERR=7
            GOTO 9999
         ENDIF
      ENDIF
      IF(LIST(ISTART+29).EQ.1)GOTO 150
*--- 16 bit physical header
C--- SWAP BYTES IF CONTROL WORD 27 SET, AND IF 16-BIT WORDS 7 AND 8
C    IN THE BLOCK HEADER ARE WRONG FOR EP FORMAT.
   71    CONTINUE
         CALL BTSWAP(IBUF,NB)
         CALL BLO16W(IBUF,1,ILBHD,1,12)
         LIST(ISTART+28)=1
   72    CONTINUE
         NP=ILBHD(1)
CD    LABEL=1070
CD    IF(DBUGFL)PRINT*,LABEL,ISTART,(LIST(ISTART+JJJ),JJJ=11,22)
         IF(NP.LE.0) GOTO 9901
         IF(NP .GT. LIST(ISTART+1).OR.NP.GT.NB/2) GOTO 9902
         NPHL=ILBHD(2)
         IF (NPHL. LT. LIST(6) .OR. NPHL .GT. NP
     1   .OR. (ILBHD(7).NE.29954) .OR. (ILBHD(8).NE.31280))
     2   GO TO 110
*--- set 16 bit header
         LIST(ISTART+29)=0
         GO TO 150
 110     CONTINUE
         IF(LIST(ISTART+27).LT.2)GOTO 120
         IERR=7
         GOTO 9999
C--OLD FORMAT
 120     IF (NPHL .LT.5 .OR. NPHL.GT.NP)IERR=7
         IF (IERR .NE.0) GOTO 9999
         LIST(ISTART+17) =1
         LIST(ISTART+3)=16
C--WE HAVE A GOOD HEADER - 16 bit or 32 bit (ILBHD(6) = 0 or 1)
  150 CONTINUE
      IF(LIST(ISTART+17).EQ.1)  GOTO 160
      LIST(ISTART+3)=ILBHD(11)
      LIST(ISTART+9)=ILBHD(6)
      LIST(ISTART+18)=ILBHD(9)
  160 CONTINUE
      LIST(ISTART+14)=NP
      LIST(ISTART+15)=ILBHD(4)
      LIST(ISTART+7)=NPHL
      LIST(ISTART+4)=ILBHD(5)
77777 RETURN
 9901 CONTINUE
C--- BLOCK LENGTH (IBUF(1)) LE 0 - PROBABLY NOT EP FORMAT
      IERR=4
      GOTO 9999
 9902 CONTINUE
C--- IBUF(1) GT REAL PRL OR UNIT BUFFER TOO SMALL
      IERR=5
 9999 CONTINUE
      LIST(ISTART+14)=0
      GOTO 77777
      END
#endif
