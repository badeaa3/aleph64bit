head	1.3;
access;
symbols
	alio83:1.3
	alio82:1.3
	alio81:1.2
	alio80:1.2
	alio74:1.2
	alio73:1.2
	alio72:1.2
	alio71:1.2
	alio70:1.2
	alio68:1.2
	alio69:1.2
	alio67:1.2
	alio66:1.2
	alio65:1.2
	alio64:1.2
	alio63:1.2
	alio62:1.2
	alio61:1.2
	alio60:1.2
	alephio53:1.2
	v4:1.1.1.1
	flr:1.1.1;
locks; strict;
comment	@c @;


1.3
date	2000.11.10.12.30.29;	author flr;	state Exp;
branches;
next	1.2;

1.2
date	96.03.13.14.59.55;	author flr;	state Exp;
branches;
next	1.1;

1.1
date	94.12.07.13.52.34;	author flr;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	94.12.07.13.52.35;	author flr;	state Exp;
branches;
next	;


desc
@@


1.3
log
@ alio8.2 - do not call BRWND in ACLOSE at end of job for epio output unit
@
text
@      SUBROUTINE ACLOSE( LUNIT ,IER)
C----------------------------------------------------------------------
CKEY ALREAD CLOSE
C   Created by SCHLATTER             21-AUG-1988
C   modified by F.Ranjard            28-NOV-1989
C
C!   Purpose   : Close   ALEPH BOS files
C    Inputs    :  LUNIT      logical unit
C                       = 0  close ALL units opened with AOPEN/AOPENW
C                            stage out all output files if needed.
C
C    Bank      : '+BUF',nr=LUNIT  as created by  BOS77
C
C    Output:      IER = 0    file properly closed
C                      -1    '+BUF' bank does not exist for this unit
C
C    Calls:   CLOSE,BRWND
C----------------------------------------------------------------------
#ifndef DOC
#include "bcs.h"
#include "alrcom.h"
      CHARACTER*(80) FNLUN
C --------------------------------------------------------------------
      IER=-1
      IF (LUNIT.NE.0) THEN
C           get index of bank '+BUF',nr=LUNIT
C           IF '+BUF',nr=LUNIT does not exist THEN RETURN
        IND=NLINK ('+BUF',LUNIT)
        IF(IND.NE.0) GOTO 11
        GOTO 999
      ENDIF
C
      IND=NAMIND('+BUF')+1
   10 IND=IW(IND-1)
   11 IF(IND.NE.0) THEN
        IER = 0
        LUN = IW(IND-2)
        IOAC = MOD(IW(IND+1),8)
        IOMD = MOD(IW(IND+1)/8,8)
        IOST = MOD(IW(IND+1)/64,8)
#if defined(ARDEB)
        WRITE(IW(6),*) ' ACLOSE: LUN,IOAC,IOMD,IOST= ',
     &                           LUN,IOAC,IOMD,IOST
#endif
C
C - files opened in direct access (IOAC=1) cannot be REWIND
        IF(IOAC.NE.1) THEN
C          rewind BOS file ( to reset BOS pointers )
          IF(LUNIT.eq.0.and.IOMD.eq.1.and.IOST.eq.2) THEN
C          do not call BRWND for epio(IOMD=1) output(IOST=2) files 
C          at end of job (LUNIT=0) to avoid to call cfrew thru epio twice
#if defined(ARDEB)
           WRITE(IW(6),*) ' ACLOSE: EOJob - do not EPRWND output',lun
#endif
          ELSE
            CALL BRWND( LUN )
          ENDIF
C
C          rewind "TEXT" files ( not yet done in BRWND )
          IF (IOMD.EQ.2) REWIND LUN
        ENDIF
C
C - epio files: when using EPIO C (IC=2) rewind the file and close it
C               reset the direct access flag to sequential
        IF (IOMD.EQ.1) THEN
           CALL EPGETW (LUN,33,IC,IST)
           IF (IC.EQ.2) THEN
              IF (IOAC.EQ.1) CALL BRWND(LUN)
              CALL EPGETW (LUN,25,LDES,IST)
#if defined(ARDEB)
              WRITE(IW(6),*) ' ACLOSE: LUN,IOAC,IOMD,IC,LDES= ',
     &                                 LUN,IOAC,IOMD,IC,LDES
#endif 
              IF (LDES.NE.0) CALL CFCLOS (LDES,0)
           ENDIF
           CALL EPSETW (LUN,32,0,IST)
        ENDIF
C
        CLOSE (LUN,IOSTAT=IST)
#if defined(ARDEB)
        WRITE(IW(6),*) ' ACLOSE: CLOSE LUN= ',LUN,' IST= ',IST
#endif 
C
C          drop BOS buffer
        IDRP = NDROP ('+BUF',LUN)
C
C           more UNITs to close ?
        IF(LUNIT.EQ.0) GOTO 10
      ENDIF
C
C     Call ASTAGE to drop any/all staged data disks
C     This will submit output staging jobs to copy to tape
      IF ( LUNIT.EQ.0 ) THEN
        CALL ASTAGE(LUNIT,' ',IRSTG)
        IF ( IER.EQ.0 ) IER = IRSTG
        CALL DROPDK
      END IF
C
 999  CONTINUE
#if defined(ARDEB)
      WRITE (IW(6),*) ' ACLOSE LUNIT= ', LUNIT, ' IER= ',IER
#endif
      END
#endif









@


1.2
log
@import alephio 52 from historian. Modify aclose.F to NOT call brwnd twice
for the same file. update version.h to 5.3
@
text
@d40 1
d42 2
a43 1
        WRITE(IW(6),*) ' ACLOSE: LUN,IOAC,IOMD= ',LUN,IOAC,IOMD
d45 2
a46 1
C          files opened in direct access cannot be REWIND
d49 10
a58 1
          CALL BRWND( LUN )
d62 3
a64 3
C          epio files: reset direct access flag to sequential
C                      when using EPIO C rewind the file and
C                      close it
d105 9
@


1.1
log
@Initial revision
@
text
@a0 1
*DK aclose
d40 3
d56 1
a56 1
              CALL BRWND(LUN)
d58 4
d68 3
@


1.1.1.1
log
@import alephio 4
@
text
@@
