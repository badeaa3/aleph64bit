head	1.3;
access;
symbols
	gal309_3:1.3
	gal309_2:1.3
	gal309_1:1.3
	gal309:1.3
	gal308_2:1.3
	gal308_1:1.3
	gal308:1.3
	gal307_2:1.3
	gal307_1:1.3
	gal307:1.3
	gal306_3:1.3
	gal306_2:1.2
	gal306_1:1.2
	gal306:1.2
	gal305_3:1.2
	gal305_2:1.2
	gal305_1:1.2
	gal305:1.2;
locks; strict;
comment	@c @;


1.3
date	98.03.06.08.55.57;	author flr;	state Exp;
branches;
next	1.2;

1.2
date	97.03.21.16.30.58;	author flr;	state Exp;
branches;
next	1.1;

1.1
date	97.03.20.08.08.45;	author flr;	state Exp;
branches;
next	;


desc
@@


1.3
log
@gal306.3 - new algorithm to store hits in LSCintillator
@
text
@      SUBROUTINE LSCHIT
C--------------------------------------------------------------
C! Deposit hit signal in Lcal scintillator
C  The trackelement is not stopped
C. - P.Hansen - 970301
C.   Modified - P. Hansen 980301
C. - Called by  GUSTEP
C -----------------------------------------------
#ifndef DOC
      SAVE
C
      INTEGER KLSNT,KLCAL,KLCRA,ISAT,MODU,NNEG,NPOS,KMOD,LE
      INTEGER IFB,MLCAL,NSCI,NPMT,NPHO1,NPHO2
      REAL XIN(3),XOUT(3),DXIN(3),R1,R2,REFF
      REAL SCPOS(3),SHEI,SWID,ATTL,EMIP,EFLU,ADCM(4),THRS
      REAL X,Y,Z,BINV,EDEP,RN1,RN2,PM1,PM2,S1,S2,E1,E2
      INTEGER NAMIND,NLCRA
      LOGICAL INIT
      DATA NCLRA /0/
      DATA INIT/ .TRUE. /
#include "bcs.h"
#include "jobcom.h"
#include "iocom.h"
#include "lcaljj.h"
#include "lsntjj.h"
#include "gckine.h"
#include "tmacrod.h"
#include "bmacro.h"

C -------------------------------------------------------------
C
C Read geometrical and other constants
      IF(NLCRA.EQ.0) THEN
        KLSNT = IW(NAMIND('LSNT'))
        KLCAL = IW(NAMIND('LCAL'))
        IF(KLSNT.NE.0 .AND. KLCAL.NE.0 ) THEN
C
C Nominal x,y,z position of scintillator
          SCPOS(1) = RW(KLCAL+LMHLEN+JLCANP)
          SCPOS(2) = RW(KLCAL+LMHLEN+JLCANP+1)
          SCPOS(3) = RW(KLCAL+LMHLEN+JLCANP+2)
C
C Scintillator height
          SHEI     = RW(KLCAL+LMHLEN+JLCAND+1)
C
C Scintillator width
          SWID     = RW(KLCAL+LMHLEN+JLCAND)
C
C Scintillator attenuation length and average attenuation
          ATTL     = RW(KLSNT+LMHLEN+JLSNAL)
          REFF     = SWID/ATTL/(1.-EXP(-SWID/ATTL))
C
C Number of photoelectr resulting from one mip in scintillator
          EMIP     = RW(KLSNT+LMHLEN+JLSNMM)
C
C Relative fluctuation in measured signal
          EFLU     = RW(KLSNT+LMHLEN+JLSNFL)
C
C Digitizings per photoelectron
          ADCM(1)  = RW(KLSNT+LMHLEN+JLSNMA)
          ADCM(2)  = RW(KLSNT+LMHLEN+JLSNMA+1)
          ADCM(3)  = RW(KLSNT+LMHLEN+JLSNMA+2)
          ADCM(4)  = RW(KLSNT+LMHLEN+JLSNMA+3)
C
C Momentum threshold for detecting a particle
          THRS     = RW(KLSNT+LMHLEN+JLSNTH)
C
C Saturation count (max digitizing)
          ISAT     = IW(KLSNT+LMHLEN+JLSNSA)
C
C Number of scintillators
          NSCI     = IW(KLSNT+LMHLEN+JLSNNS)
C
C Number of phototubes per scintillator
          NPMT     = IW(KLSNT+LMHLEN+JLSNNP)
        ELSE
          IF(KLCAL.EQ.0) WRITE(LOUTIO,'(//,2X,A)')
     &     '+++ LSCHIT +++ No LCAL bank'
          IF(KLSNT.EQ.0) WRITE(LOUTIO,'(//,2X,A)')
     &     '+++ LSCHIT +++ No LSNT bank'
          SCPOS(1) = 0.0
          SCPOS(2) = 30.75
          SCPOS(3) = 307.80
          SHEI     = 26.6
          SWID     = 4.6
          ATTL     = 3.0
          REFF     = 1.955
          EMIP     = 0.6
          EFLU     = 0.6
          ADCM(1)  = 500.
          ADCM(2)  = 500.
          ADCM(3)  = 500.
          ADCM(4)  = 500.
          THRS     = 0.002
          ISAT     = 32000
          NSCI     = 4
          NPMT     = 2
        ENDIF
        CALL BKFMT('LCRA','I')
        NLCRA = NAMIND('LCRA')
      ENDIF
C
C - Signal is deposited at first entrance of a track element
      IF(ITRKEL(8).NE.1)                               RETURN
C
C - Transform track to local coordinates
      CALL LCFRAL(IFB,MLCAL,XIN,XOUT,DXIN)
C
C - Find the scintillator number
      X=XIN(1)
      Y=XIN(2)
      Z=XIN(3)
      IF( MLCAL .LE. 2) THEN
        MODU = 2
        IF( Y .GT. 0.) MODU = 1
      ELSE
        MODU = 3
        IF( Y .GT. 0.) MODU = 4
      ENDIF
C
C - The average number of detected scintillator photons (EDEP)
C   for an incoming geantino is estimated to be n(mip)(2+15*E(GeV))
      IF(IGTRTY .EQ. 6) THEN
        EDEP = EMIP*(2. + 15.*TRKELE(8))
C   otherwise apply the PDB factor for low beta to n(mip)
      ELSE
        BINV    = TRKELE(8)/TRKELE(7)
        EDEP    = EMIP*BINV**(5/3)
      ENDIF
C
C - Find effective light attenuation factors
      IF(ABS(X).LT.SWID/2.) THEN
        R1 = EXP(-(SWID/2.-X)/ATTL)
        R2 = EXP(-(SWID/2.+X)/ATTL)
      ELSEIF(X.GT.0.) THEN
        R1 = 1.
        R2 = 0.
      ELSE
        R1 = 0.
        R2 = 1.
      ENDIF
C
C - Find the number of photons detected by each sensor
      NPHO1 = 0
      NPHO2 = 0
      E1 = EDEP*REFF*R1
      E2 = EDEP*REFF*R2
      IF(E1.GT.0.1) CALL POISSN(E1,NPHO1,IERR)
      IF(E2.GT.0.1) CALL POISSN(E2,NPHO2,IERR)
      S1 = FLOAT(NPHO1)
      S2 = FLOAT(NPHO2)
C
C - Fluctuate the PM pulse
      CALL RANNOR(RN1,RN2)
      IF(S1.GT.0.1) THEN
        PM1 = S1*(1.+RN1*EFLU/SQRT(S1))
      ELSE
        PM1 = 0.
      ENDIF
      IF(S2.GT.0.1) THEN
        PM2 = S2*(1.+RN2*EFLU/SQRT(S2))
      ELSE
        PM2 = 0.
      ENDIF
C
C - Digitize the signal
      NPM1 = NINT(PM1*ADCM(MODU))
      NPM2 = NINT(PM2*ADCM(MODU))
      IF(NPM1.LE.0.AND.NPM2.LE.0) RETURN
C
C - If output bank exists, add the signal until saturation
      KLCRA = IW(NLCRA)
      IF(KLCRA.NE.0) THEN
        KMOD = KROW(KLCRA,MODU)
        IW(KMOD+1) = MIN( IW(KMOD+1) + NPM1 , ISAT )
        IW(KMOD+2) = MIN( IW(KMOD+2) + NPM2 , ISAT )
C - Otherwise create bank and add signal until saturation
      ELSE
        LE = LMHLEN+NPMT*NSCI
        CALL ALBOS('LCRA',0,LE,KLCRA,IGARB)
        CALL BLIST(IW,'E+','LCRA')
        IW(KLCRA+1) = NPMT
        IW(KLCRA+2) = NSCI
        KMOD = KROW(KLCRA,MODU)
        IW(KMOD+1) = MIN( NPM1 , ISAT )
        IW(KMOD+2) = MIN( NPM2 , ISAT )
      ENDIF
  999 RETURN
      END
#endif
@


1.2
log
@gal305.0 :cosmetic update to lcshow and lschit
@
text
@a0 1
*DK lschit
d6 1
d13 2
a14 2
      INTEGER IFB,MLCAL,NSCI,NPMT
      REAL XIN(3),XOUT(3),DXIN(3)
d16 2
a17 3
      REAL X,Y,Z,BINV,EDEP,RN1,RN2,DLIGH,SADC,C1,R1,SPOS,SNEG
      INTEGER NAMIND
      EXTERNAL NAMIND
d19 1
a20 1
C
d29 1
d33 1
a33 1
      IF(INIT) THEN
d49 1
a49 1
C Scintillator attenuation length
d51 1
d53 1
a53 1
C Energy deposited by one mip in lead+scint
d56 1
a56 1
C Relative fluctuation in energy deposit
d59 1
a59 1
C Digitizings per MeV
d86 8
a93 7
          ATTL     = 100.
          EMIP     = 2.
          EFLU     = 0.3
          ADCM(1)  = 1000.
          ADCM(2)  = 1000.
          ADCM(3)  = 1000.
          ADCM(4)  = 1000.
d95 1
a95 1
          ISAT     = 6250
d99 1
a99 1
        INIT = .FALSE.
a100 1
        CALL BKFMT('LCRA','(I)')
d114 2
a115 2
        MODU = 1
        IF( Y .GT. 0.) MODU = 2
d121 2
a122 9
C - Make sure the particle hits the scintillator
      IF(ABS(X) .GT. SWID/2. .OR.
     &   ABS(ABS(Y)-SCPOS(2)) .GT. SHEI/2.)            RETURN
C
C - Apply a minimum momentum
      IF (TRKELE(7).LT.THRS)                           RETURN
C
C - Find average energy deposition
C   If geantino deposit 3% of energy in MeV
d124 2
a125 2
        EDEP = 0.03*TRKELE(7)*1000.
C   otherwise apply the PDB factor for low beta
d131 7
a137 4
C - Fluctuate the energy (by at most 0.5 downwards)
      CALL RANNOR(RN1,RN2)
      IF (RN1*EFLU .GT. -0.5) THEN
        EDEP = EDEP*(1.+RN1*EFLU)
d139 2
a140 1
        EDEP = 0.5*EDEP
d143 9
a151 3
C - Attenuate the light reaching the two photomultipliers
      DLIGH = ABS(Y)-SCPOS(2)+SHEI/2.
      SADC  = EDEP*EXP(-DLIGH/ATTL)
d153 12
a164 5
C - Divide it between them according to the cosine factor
      C1    = SWID**2+DLIGH**2+X**2
      R1    = SQRT( (C1-2.*SWID*X)/(C1+2.*SWID*X))
      SNEG  = SADC*R1/(1.+R1)
      SPOS  = SADC/(1.+R1)
d167 3
a169 2
      NNEG = NINT(SNEG*ADCM(MODU))
      NPOS = NINT(SPOS*ADCM(MODU))
d175 2
a176 2
        IW(KMOD+1) = MIN( IW(KMOD+1) + NNEG , ISAT )
        IW(KMOD+2) = MIN( IW(KMOD+2) + NPOS , ISAT )
d180 1
a180 1
        CALL AUBOS('LCRA',0,LE,KLCRA,IGARB)
d185 2
a186 2
        IW(KMOD+1) = MIN( NNEG , ISAT )
        IW(KMOD+2) = MIN( NPOS , ISAT )
@


1.1
log
@release galeph 305
@
text
@d13 1
a13 1
      INTEGER IFB,MLCAL
a24 1
#include "lcrajj.h"
a35 1
        NLCRA = NAMIND('LCRA')
d69 6
d94 2
d98 1
a165 1
C   one row per scintillator
d167 1
a167 1
        LE = LMHLEN + LLCRAA*4
d170 2
a171 2
        IW(KLCRA+LMHCOL) = LLCRAA
        IW(KLCRA+LMHROW) = 4
@
