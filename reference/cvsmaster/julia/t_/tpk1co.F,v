head	1.5;
access;
symbols
	jul313_3:1.5
	jul313_2:1.5
	jul313_1:1.5
	jul313:1.5
	jul312_1:1.5
	jul312:1.5
	jul311:1.5
	jul310_1:1.5
	jul310:1.5
	jul309_1:1.5
	jul309:1.5
	jul308_6:1.5
	jul308_5:1.5
	jul308_4:1.5
	jul308_3:1.5
	jul308_2:1.5
	jul308_1:1.5
	jul308:1.5
	jul307_4:1.5
	jul307_3:1.5
	jul307_2:1.5
	jul307_1:1.5
	jul307:1.5
	jul306_3:1.5
	jul306_2:1.5
	jul306_1:1.5
	jul306:1.5
	jul305_4:1.5
	jul305_3:1.5
	jul305_2:1.5
	jul305_1:1.5
	jul305:1.5
	jul304_3:1.5
	jul304_2:1.5
	jul304_1:1.5
	jul304:1.5
	jul303_7:1.5
	jul303_6:1.5
	jul303_5:1.5
	jul303_4:1.5
	jul303_3:1.5
	jul303_2_mc1:1.5
	jul303_2:1.5
	jul303_1_mc1:1.5
	jul303_1:1.5
	jul303_v:1.5
	jul303:1.5
	jul302_6:1.3
	jul302_5:1.3
	jul302_4:1.3
	jul302_3:1.3
	jul302_2:1.2
	jul302_1:1.2
	jul302:1.4
	jul285_1:1.2
	jul285:1.2
	jul284_1:1.2
	jul284:1.2
	jul283_1:1.2
	jul283:1.2
	jul282_1:1.2
	jul282:1.2
	jul281_3:1.2
	jul281_2:1.2
	jul281_1:1.2
	jul281:1.2
	jul280_1:1.2
	jul280:1.2
	jul279:1.1.1.1
	v300:1.1.1.1
	flr:1.1.1;
locks; strict;
comment	@c @;


1.5
date	97.05.14.16.13.28;	author cattanem;	state Exp;
branches;
next	1.4;

1.4
date	97.05.14.06.37.19;	author cattanem;	state Exp;
branches;
next	1.3;

1.3
date	97.03.26.15.29.54;	author cattanem;	state Exp;
branches;
next	1.2;

1.2
date	96.03.12.15.43.16;	author flr;	state Exp;
branches;
next	1.1;

1.1
date	94.12.07.14.20.09;	author aljul;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	94.12.07.14.20.10;	author aljul;	state Exp;
branches;
next	;


desc
@@


1.5
log
@ignore ITC only tracks in tpk1co.F
@
text
@      SUBROUTINE TPK1CO(IC,IPTNC)
C
C-----------------------------------------------------------------------
C! Fill one entry into the PTNC bank
C!
C!    Author:  R. Johnson     15-06-88
C!
C!    Modified:D. Casper      26-03-97  Remove requirement that errors
C!                                      fit into a byte, to allow scale
C!                                      factors to change and round-off
C!                                      to be reduced.
C!
C!                            13-05-97  Recalculate the coordinate errors
C!                                      appropriate for only pad coordinates,
C!                                      since the content of the TPCO
C!                                      bank represents the error on the
C!                                      combined pad and wire coordinate
C!                                      (if any) at this point.
C!
C!    Input:   IC       /I      Coordinate number in TPCO
C!    Output:  IPTNC(6) /I      A single row of the PTNC bank
C!
C!    Called by TPAKCO
C!
C-----------------------------------------------------------------------
#ifndef DOC
C
#include "alcons.h"
#include "bcs.h"
#include "tpcojj.h"
#include "ptncjj.h"
#include "tpgpar.h"
#include "tpgeom.h"
#include "tpgeop.h"
#include "ptunjj.h"
#include "tgftjj.h"
#include "pcoijj.h"
C
      CHARACTER TEXT*90
      DIMENSION IPTNC(*)
      LOGICAL FIRST
      DATA FIRST/.TRUE./
C
#include "bmacro.h"
C
      IF (FIRST) THEN
        FIRST=.FALSE.
        NPTUN=NAMIND('PTUN')
        NTPCO=NAMIND('TPCO')
        NPCOI=NAMIND('PCOI')
        NTGFT=NAMIND('TGFT')
        NPTNC=NAMIND('PTNC')
      ENDIF
      KPTUN=IW(NPTUN)+LMHLEN
      KTPCO=IW(NTPCO)
      KPCOI=IW(NPCOI)
      KTGFT=IW(NTGFT)
      KPTNC=IW(NPTNC)
C
      ID=ITABL(KTPCO,IC,JTPCIN)
      IROW=ID/100000
      ISLOT=(ID-IROW*100000)/1000
      ISTYP=ITPTYP(ISLOT)
      IF (ISTYP.NE.1) THEN
        IROWS=IROW-NTPDRW(1)
      ELSE
        IROWS=IROW
      ENDIF
      IPTNC(JPTNSL)=ISLOT
      IPTNC(JPTNSR)=IROWS
      PHI=RTABL(KTPCO,IC,JTPCPH)
      Z=RTABL(KTPCO,IC,JTPCZV)
      R=RTABL(KTPCO,IC,JTPCRV)
C
C++   Save only the raw, uncorrected values (in sector coord sys.)
C
      RPHIS=RTABL(KTPCO,IC,JTPCRR)
      ZS=RTABL(KTPCO,IC,JTPCRZ)
C
      IPTNC(JPTNRP)=NINT(RPHIS/RW(KPTUN+JPTURP))
      IPTNC(JPTNZV)=NINT(ZS/RW(KPTUN+JPTUZS))
C
C++  Recalculate the coordinate errors here.  Only coordinates on tracks
C++  need special treatment.
C
      ITK = ITABL(KTPCO,IC,JTPCTN)
      IF (ITK.GT.0 .AND.ITK.LE.LROWS(KTGFT)) THEN
        KCO = KROW(KTPCO,IC)
        KTK = KROW(KTGFT,ITK)
C
C++  Check whether Landau corrections were done, since this affects the error
C
        ICORW = IW(KCO+JTPCOF)/10
C
C++  Dip angle OF track and z position of coordinate
C
        TALA = RW(KTK+JTGFTL)
        Z = RW(KCO+JTPCZV)
C
C++  Number of half pads and the pad crossing angle complete the story
C
        NHALF = ITABL(KPCOI,IC,JPCONH)
        CALL TFILPA(KCO,KTK,PADCRO,WIRCRO)
C
C++  Get the error for the pads alone
C
        CALL TERPAR(PADCRO,Z,TALA,NHALF,ICORW,SRPHI,SZ)

C
C++  If not on a track, just copy TPCO with some sanity checks
C
      ELSE
        DRPHI=RTABL(KTPCO,IC,JTPCSR)
C
C++   If the variances of r*phi and z are negative, then there must have
C++   been a bug somewhere.  Nonetheless, we patch them here by setting
C++   them to some more reasonable value.
C
        IF (DRPHI.GE.0.) THEN
            SRPHI=SQRT(DRPHI)
        ELSE
            SRPHI=0.01
            CALL RERROR('TPK1CO',3,
     &                   'DRPHI**2 negative! Set DRPHI to 100 microns')
        ENDIF
        DZ=RTABL(KTPCO,IC,JTPCSZ)
        IF (DZ.GE.0.) THEN
         SZ=SQRT(DZ)
        ELSE
         SZ=0.08
         CALL RERROR('TPK1CO',4,'DZ**2 negative! Set DZ to 800 microns')
        ENDIF
      ENDIF
      IPTNC(JPTNSP)=NINT(SRPHI/RW(KPTUN+JPTUSR))
      IPTNC(JPTNSZ)=NINT(SZ/RW(KPTUN+JPTUSZ))
C
      RETURN
      END
#endif
@


1.4
log
@Bug fixes for TPC pad coordinate errors
@
text
@d87 1
a87 1
      IF (ITK.GT.0) THEN
@


1.3
log
@Changes to error packing in PTUN
@
text
@d13 7
d36 2
d50 2
d56 2
d82 32
a113 1
      DRPHI=RTABL(KTPCO,IC,JTPCSR)
d119 5
a123 5
      IF (DRPHI.GE.0.) THEN
        SRPHI=SQRT(DRPHI)
      ELSE
        SRPHI=0.01
        CALL RERROR('TPK1CO',3,
d125 8
a132 7
      ENDIF
      DZ=RTABL(KTPCO,IC,JTPCSZ)
      IF (DZ.GE.0.) THEN
        SZ=SQRT(DZ)
      ELSE
        SZ=0.08
        CALL RERROR('TPK1CO',4,'DZ**2 negative! Set DZ to 800 microns')
@


1.2
log
@import jul280 from historian
Modified Files:
	aamain.F aboldr.F ajmmcl.F almmcl.F altime.F aulpol.F
	bccrun.F bcpack.F binijo.F biniru.F bmsum.F bpreda.F bprsum.F
	bslowc.F
	cabook.F calrec.F calrel.F calrep.F calsup.F cashet.F casmp.F
	casneu.F casnmp.F cclorl.F cctrmi.F ccutpe.F cdang.F cdths.F
 	cegclu.F cencch.F cencne.F cesclu.F cexcob.F cexhis.F cfpass.F
 	cfpmip.F cfpnmp.F cgrunc.F chclu.F chgclu.F chsclu.F cinijo.F
 	cinirl.F cinpar.F cinsrl.F cisgam.F cishit.F cludis.F cmoni.F
 	cnighb.F coslst.F cpadwr.F cparad.F cpotcr.F cpoteh.F cpotlc.F
 	cptcom.F crcalo.F crchrl.F crcjob.F crcpar.F crhclu.F cthclu.F
 	ctkchg.F ctrmip.F ctrpar.F ctrtoc.F cvrify.F
 	e1bpei.F e2bpei.F e3bpei.F e4bary.F e4cosz.F e4dead.F e4deij.F
 	e4fdij.F e4fide.F e4find.F e4fnec.F e4frac.F e4gtbr.F e4gtpl.F
 	e4gtso.F e4gtst.F e4gttw.F e4indi.F e4lea1.F e4ovrl.F e4pal.F
 	e4r1r2.F e4r2r3.F e4r3r4.F e4radc.F e4res2.F e4res3.F e4tstl.F
 	e4xyz0.F eautop.F ebegid.F eboxki.F ecalig.F ecblda.F ecboba.F
	ecbook.F eccaob.F ecchkb.F ecclco.F ecclus.F ecdamp.F ecdebg.F
 	ecdete.F ecdigi.F ecener.F eceras.F ecfclu.F ecfils.F ecfmip.F
 	ecfobj.F ecgflw.F ecgmix.F echarg.F echcgl.F echedc.F echiba.F
 	echist.F echtag.F ecinit.F ecinrv.F eclamp.F eclana.F ecleib.F
 	eclgeo.F eclope.F eclorl.F eclost.F ecltag.F ecltrk.F ecltyp.F
 	ecluar.F ecmesp.F ecmod.F ecmopl.F ecncob.F ecobnk.F ecoent.F
 	ecoidp.F ecos.F ecpasr.F ecplm.F ecprin.F ecprlo.F ecrcob.F
 	ecre4d.F ecreib.F ecrmip.F ecrndx.F ecrpei.F ecrtr.F ecrunq.F
 	ecscmd.F ecst.F ecsupp.F ecsw1093.F ecsw94.F ectemp.F ecthre.F
 	ectopo.F ectpc.F ectrap.F ectrea.F ecxmod.F edisal.F edlist.F
 	efaxe.F efbook.F eferrr.F eficlp.F eficv.F efiecp.F efieib.F
 	efijob.F efix.F efixi94.F eflcst.F efolmk.F efpard.F eftiel.F
 	egacst.F egaest.F egetds.F egfcst.F egttks.F ehcflo.F ehlix.F
 	ehreg.F eidedx.F eident.F eieffl.F einhlx.F einijo.F einirl.F
 	einiru.F einitk.F einsrl.F eipard.F eithr.F eknewb.F eknewe.F
 	elecid.F elongi.F emfill.F emskei.F emskev.F emskf.F emski.F
 	emskji.F emskmu.F enfmsk.F enighb.F enoise.F enprox.F enstat.F
 	epadcl.F epatrn.F epcalo.F epchg.F epneu.F epreda.F eproba.F
 	eprsto.F eprsum.F eprtpc.F ereset.F eroad.F escdef.F escoun.F
 	esfil.F eslas.F eslct.F eslctf.F eslowc.F estag.F esveto.F
 	eswpst.F etdifp.F ethres.F etrdev.F ewdifp.F ewircl.F ex3ijk.F
 	fawian.F ffield.F fidhea.F fidrot.F finiru.F fitall.F fitwri.F
 	fkink.F fkkpar.F floweh.F flowfi.F flowtr.F fmuid.F fpiden.F
 	frefit.F ftpcer.F ftrack.F
 	gambnk.F gapeco.F gasteer.F
 	hcalib.F hcalrd.F hcatow.F hcbhis.F hcfclu.F hchist.F hclcra.F
 	hcltst.F hclufi.F hcos.F hcsimm.F hdgdeb.F hdgfil.F hdgpot.F
 	hdgsum.F hdprec.F hdspre.F hflnoi.F hinijo.F hiniru.F hmener.F
 	hmfind.F hmroad.F hnoise.F hnoisy.F hpatco.F hphnoi.F hplink.F
 	hprana.F hpranp.F hprdig.F hpreda.F hprpot.F hprsum.F hprunc.F
 	hrcomp.F hrcpat.F hrdcal.F hroad.F hslink.F hslowc.F hspare.F
 	hsptre.F hstofi.F htrack.F htubfi.F htwcr.F
 	iasign.F iattma.F ibnkin.F icaswt.F icftoi.F iclimb.F icrcco.F
 	ideadw.F idigpr.F ienang.F ifind1.F ifind2.F ifitp.F iftrak.F
 	igetti.F igettp.F igicha.F iheler.F iinijo.F iiniru.F iintrk.F
 	imatch.F inigap.F insect.F intrak.F ipakdi.F ipdsti.F iphcor.F
 	ipreda.F iprsum.F ipstat.F irefin.F ireopd.F isave.F ishuff.F
 	ishufl.F islowc.F isrch.F itbook.F itccut.F itcopr.F itcrec.F
 	itcrep.F itctpc.F itctrk.F itcxng.F iterr.F itextn.F ithist.F
 	itidy1.F itidy2.F itlnk1.F itlnk2.F itpcan.F itrak.F itrecf.F
 	itreci.F itree.F itrkci.F itrkeq.F itrkzr.F itrmca.F
@
text
@d8 5
d33 1
a33 1
      DATA FIRST/.TRUE./, LBYTE/255/, LHBYT/127/
a89 7
      IF (IPTNC(JPTNSP).GT.LBYTE) THEN
        IPTNC(JPTNSP)=LBYTE
        WRITE(TEXT,36) SRPHI
   36   FORMAT('Sigma r*phi of ',E12.5,' is too large to pack',
     &         ' into a single byte and is truncated.')
        CALL RERROR('TPK1CO',2,TEXT(1:85))
      ENDIF
a90 7
      IF (IPTNC(JPTNSZ).GT.LBYTE) THEN
        IPTNC(JPTNSZ)=LBYTE
        WRITE(TEXT,37) SZ
   37   FORMAT('Sigma z of ',E12.5,' is too large to pack',
     &         ' into a single byte and is truncated.')
        CALL RERROR('TPK1CO',3,TEXT(1:81))
      ENDIF
@


1.1
log
@Initial revision
@
text
@a0 1
*DK tpk1co
@


1.1.1.1
log
@import julia 300
@
text
@@
