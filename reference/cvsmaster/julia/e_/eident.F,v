head	1.2;
access;
symbols
	jul313_3:1.2
	jul313_2:1.2
	jul313_1:1.2
	jul313:1.2
	jul312_1:1.2
	jul312:1.2
	jul311:1.2
	jul310_1:1.2
	jul310:1.2
	jul309_1:1.2
	jul309:1.2
	jul308_6:1.2
	jul308_5:1.2
	jul308_4:1.2
	jul308_3:1.2
	jul308_2:1.2
	jul308_1:1.2
	jul308:1.2
	jul307_4:1.2
	jul307_3:1.2
	jul307_2:1.2
	jul307_1:1.2
	jul307:1.2
	jul306_3:1.2
	jul306_2:1.2
	jul306_1:1.2
	jul306:1.2
	jul305_4:1.2
	jul305_3:1.2
	jul305_2:1.2
	jul305_1:1.2
	jul305:1.2
	jul304_3:1.2
	jul304_2:1.2
	jul304_1:1.2
	jul304:1.2
	jul303_7:1.2
	jul303_6:1.2
	jul303_5:1.2
	jul303_4:1.2
	jul303_3:1.2
	jul303_2_mc1:1.2
	jul303_2:1.2
	jul303_1_mc1:1.2
	jul303_1:1.2
	jul303_v:1.2
	jul303:1.2
	jul302_6:1.2
	jul302_5:1.2
	jul302_4:1.2
	jul302_3:1.2
	jul302_2:1.2
	jul302_1:1.2
	jul302:1.2
	jul285_1:1.2
	jul285:1.2
	jul284_1:1.2
	jul284:1.2
	jul283_1:1.2
	jul283:1.2
	jul282_1:1.2
	jul282:1.2
	jul281_3:1.2
	jul281_2:1.2
	jul281_1:1.2
	jul281:1.2
	jul280_1:1.2
	jul280:1.2
	jul279:1.1.1.1
	v300:1.1.1.1
	flr:1.1.1;
locks; strict;
comment	@c @;


1.2
date	96.03.12.14.55.32;	author flr;	state Exp;
branches;
next	1.1;

1.1
date	94.12.07.14.17.56;	author aljul;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	94.12.07.14.17.57;	author aljul;	state Exp;
branches;
next	;


desc
@@


1.2
log
@import jul280 from historian
Modified Files:
	aamain.F aboldr.F ajmmcl.F almmcl.F altime.F aulpol.F
 Modified Files:
	bccrun.F bcpack.F binijo.F biniru.F bmsum.F bpreda.F bprsum.F
	bslowc.F
	cabook.F calrec.F calrel.F calrep.F calsup.F cashet.F casmp.F
	casneu.F casnmp.F cclorl.F cctrmi.F ccutpe.F cdang.F cdths.F
 	cegclu.F cencch.F cencne.F cesclu.F cexcob.F cexhis.F cfpass.F
 	cfpmip.F cfpnmp.F cgrunc.F chclu.F chgclu.F chsclu.F cinijo.F
 	cinirl.F cinpar.F cinsrl.F cisgam.F cishit.F cludis.F cmoni.F
 	cnighb.F coslst.F cpadwr.F cparad.F cpotcr.F cpoteh.F cpotlc.F
 	cptcom.F crcalo.F crchrl.F crcjob.F crcpar.F crhclu.F cthclu.F
 	ctkchg.F ctrmip.F ctrpar.F ctrtoc.F cvrify.F
 	e1bpei.F e2bpei.F e3bpei.F e4bary.F e4cosz.F e4dead.F e4deij.F
 	e4fdij.F e4fide.F e4find.F e4fnec.F e4frac.F e4gtbr.F e4gtpl.F
 	e4gtso.F e4gtst.F e4gttw.F e4indi.F e4lea1.F e4ovrl.F e4pal.F
 	e4r1r2.F e4r2r3.F e4r3r4.F e4radc.F e4res2.F e4res3.F e4tstl.F
 	e4xyz0.F eautop.F ebegid.F eboxki.F ecalig.F ecblda.F ecboba.F
	ecbook.F eccaob.F ecchkb.F ecclco.F ecclus.F ecdamp.F ecdebg.F
 	ecdete.F ecdigi.F ecener.F eceras.F ecfclu.F ecfils.F ecfmip.F
 	ecfobj.F ecgflw.F ecgmix.F echarg.F echcgl.F echedc.F echiba.F
 	echist.F echtag.F ecinit.F ecinrv.F eclamp.F eclana.F ecleib.F
 	eclgeo.F eclope.F eclorl.F eclost.F ecltag.F ecltrk.F ecltyp.F
 	ecluar.F ecmesp.F ecmod.F ecmopl.F ecncob.F ecobnk.F ecoent.F
 	ecoidp.F ecos.F ecpasr.F ecplm.F ecprin.F ecprlo.F ecrcob.F
 	ecre4d.F ecreib.F ecrmip.F ecrndx.F ecrpei.F ecrtr.F ecrunq.F
 	ecscmd.F ecst.F ecsupp.F ecsw1093.F ecsw94.F ectemp.F ecthre.F
 	ectopo.F ectpc.F ectrap.F ectrea.F ecxmod.F edisal.F edlist.F
 	efaxe.F efbook.F eferrr.F eficlp.F eficv.F efiecp.F efieib.F
 	efijob.F efix.F efixi94.F eflcst.F efolmk.F efpard.F eftiel.F
 	egacst.F egaest.F egetds.F egfcst.F egttks.F ehcflo.F ehlix.F
 	ehreg.F eidedx.F eident.F eieffl.F einhlx.F einijo.F einirl.F
 	einiru.F einitk.F einsrl.F eipard.F eithr.F eknewb.F eknewe.F
 	elecid.F elongi.F emfill.F emskei.F emskev.F emskf.F emski.F
 	emskji.F emskmu.F enfmsk.F enighb.F enoise.F enprox.F enstat.F
 	epadcl.F epatrn.F epcalo.F epchg.F epneu.F epreda.F eproba.F
 	eprsto.F eprsum.F eprtpc.F ereset.F eroad.F escdef.F escoun.F
 	esfil.F eslas.F eslct.F eslctf.F eslowc.F estag.F esveto.F
 	eswpst.F etdifp.F ethres.F etrdev.F ewdifp.F ewircl.F ex3ijk.F
@
text
@      SUBROUTINE EIDENT(ICLN,NTR,IT)
C----------------------------------------------------------------------
C!      MAIN ROUTINE  FOR ELECTRON IDENTIFICATION
C!    AUTHOR  : D. PALLIN
C!   Modified :- E. Lancon             27-SEP-1991
C!                Do not do elec_id if track not extrapolable to ecal
C!    MODIFIED:
C!
C!      JOB FOR R1 R2 R2 R3 R4 R5 ESTIMATORS CALCULATION
C!          AND HYPOTHESIS
C!      ICLN: NUMERO CLUSTER ; NTR: NUMERO TRACK TPC ; IT: CLUSTER TRACK
C?
C!======================================================================
#ifndef DOC
      COMMON/BARY/XB11,XB21,XB31,XB12,XB22,XB32,XB13,XB23,XB33
      PARAMETER(PMAX=300.)
#include "e4iden.h"
#include "e4com1.h"
#include "etpinf.h"
#include "bcs.h"
#include "rlunit.h"
#include "alcons.h"
#include "rconds.h"
#include "frftjj.h"
#include "rflags.h"
#include "rparac.h"
#include "eidtbk.h"
#include "eclujj.h"
#include "ecnamc.h"
#include "e4par1.h"
#include "eibpjj.h"
#include "eibpr2.h"
#include "eiflag.h"
#include "frtljj.h"
      COMMON/TAGG/TETI,ECLEAK1,EBAR,EEND,COC0,EREAR
      DIMENSION STAC(6),ANGL(2),PHOT(20)
      DIMENSION RES(5)
      DATA RES/.28,.35,.35,.29,.1925/
#include "bmacro.h"
C
      DATA IFIRST/0/
      IF(IFIRST.EQ.0)THEN
        CALL EIPARD
        IFIRST=IFIRST+1
      ENDIF
C
      IGAL=IW(NAMIND('AJOB'))
      R1=1000.
      R2=1000.
      R3=1000.
      R4=1000.
      R5=1000.
      R6=1000.
      R7=1000.
      E41=0.
      E42=0.
      E43=0.
      IPP=0
      ECORR=0.
C!!!!  FILL COMMON ETPINF FOR CHARGED CLUSTERS ANALYSIS
C
C     MOMENTUM OF CHARGED TRACKS
      KFRFT=IW(NAMIND('FRFT'))
      IF (KFRFT.LE.0) THEN
        CALL RERROR ('EIDENT',1,'No FRFT bank, EIDENT ---> exit')
        GO TO 999
      ENDIF
      KFRTL=IW(NAMIND('FRTL'))
      IF (KFRTL.LE.0) THEN
        CALL RERROR ('EIDENT',1,'NO FRTL BANK, EIDENT ---> EXIT')
        GO TO 999
      ENDIF
      NTT=ITABL(KFRTL,NTR,JFRTNT)
C REJECT TRACKS WITH LESS THAN 4 HITS IN TPC
      IF(NTT.LT.4)GOTO 998
      RHO=-1./RTABL(KFRFT,NTR,JFRFIR)
      CHTP=1.
      IF(RHO.LT.0) THEN
           RHO=-RHO
           CHTP=-1.
           ENDIF
      PTRAN=ABS(FIELRC)*CLGHT*RHO/1.E5
      PHI=RTABL(KFRFT,NTR,JFRFP0)
C   beware ITC tracks with lambda=90 degrees since no z measurement.
      TGTETA=RTABL(KFRFT,NTR,JFRFTL)
      IF (TGTETA.NE.0.) THEN
          TGTETA = 1. / TGTETA
      ELSE
          TGTETA = 1.E5
      ENDIF
      PZTP=PTRAN/TGTETA
      PXTP=PTRAN*COS(PHI)
      PYTP=PTRAN*SIN(PHI)
      D0=RTABL(KFRFT,NTR,JFRFD0)
      X0TP=D0*SIN(PHI)
      Y0TP=-D0*COS(PHI)
      Z0TP=RTABL(KFRFT,NTR,JFRFZ0)
      PTTP=SQRT(PTRAN**2+PZTP**2)
C
C     protect against badly measured (high momentum) tracks
C
CDIF
      IF(PTTP.GT.PMAX) GOTO 998
      C0TP=PXTP/PTTP
      C1TP=PYTP/PTTP
      C2TP=PZTP/PTTP
C
      KECLU=IW(NAECLU)
      ECLU=RW(KROW(KECLU,ICLN)+JECLE4)
C!!!! R2 ESTIMATOR
C
      CALL E4PAL(ICLN,IT,NTR,IERO)
C IERO=0 STOREYS SELECTED WITH EXTRAPOLATED TRACK
C IERO.NE.0 STOREYS SELECTED WITH CLUSTER BARYCENTER
C IERO=3 NO STOREYS SELECTED
C IERO=2 NO TRACK EXTRAPOLATION AVAILABLE
      IF(IERO.EQ.3 .OR. IERO.EQ.2 )GOTO 998
C  RESOLUTION...  TAKE IN ACCOUNT OVERLAP IF NECESSARY
C--------------------------------  ECAL
      TETQ=TETIFL
      IF(TETIFL.GT.100)TETQ=229-TETQ
      ITT=INT(TETQ)-50
      IF(ITT.LE.0.OR.ITT.GT.5)ITT=5
      RESE2=(RES(ITT)*SQRT(PTTP)+.0033*PTTP)**2
C     RESE2=(ECALRS*SQRT(PTTP)+.0033*PTTP)**2
C--------------------------------   TPC
C     RESP2=(1.5E-3*PTTP*PTRAN)**2
      XCOS=ABS(PZTP/PTTP)
      IF(XCOS.LE..76)THEN
               FCOS=1.
      ELSE
      FCOS=.9-.124*XCOS+3.9*XCOS**2+.76*XCOS**3-20.63*XCOS**4-XCOS**5
     &+24.54*XCOS**6
      ENDIF
      RESP2=((1.E-3*PTRAN+.003)*FCOS*PTTP)**2
C--------------------------------
C CHECK IF ENERGY FOUND IN FRONT OF TRACK IT
      IF(E4CLU(IT).LT.0.0001)GOTO 997
C SI ON N A PAS EXTRAPOLE  ( PASSAGE E4BARY) ON NE VA PAS DANS E4OVRL
      IOFL=0
      IF(IERO.EQ.0)
     &CALL E4OVRL(ICLN,IT,NTR,R3ESTI(IT),R4ESTI(IT),IOFL)
C--------------------------------
C VALEUR MOYENNE   & ZERO SUPPRESSION CORRECTION
C--------------------------------
      CORSZ = 1.
      CALL E4COSZ(ECLU,PTTP,TETIFL,XE4100,CORSZ)
C--------------------------------
C LEAKEAGE CORRECTION   OUT OF OVERLAP
C? GET THETA,PHI
      IF(IOFL.EQ.0)THEN
       TETA = RTABL(KECLU,ICLN,JECLT4)
       PHI = RTABL(KECLU,ICLN,JECLF4)
       STAC(1) = ECLU
       STAC(2) = 0.
       STAC(3) = 0.
       STAC(4) = 0.
       STAC(5) = TETA
       STAC(6) = PHI
       CORR    = 1.
       ANGL(1) = TETA
       ANGL(2) = PHI
C
       ICHR = 1
       CALL ECLEAK( 0 , STAC , ANGL , ICHR, CORR)
       ECLEA= ECLU*(CORR-1.)
       E4CLU(IT)=E4CLU(IT)+ECLEA
C--------------------------------
C     CORRECTION FOR RT AT LOW MOMENTUM (TO BE CHANGED)
C--------------------------------
C? Compute cluster correction   (use Badier routine)
       ECC0  = ECLU*(CORSZ-1.)
       E4CLU(IT)=E4CLU(IT)+ECC0
      ENDIF
C--------------------------------
C SATURATION CORRECTION  ON DATA ONLY
C THE TOTAL SATURATION CORRECTION IS SUPPOSED TO BE CONCENTRATED ON
C THE 2X2 CENTERED TOWERS
C WE COMPUTE THE TOTAL SATURATION CORR AND APPLY ON 2X2 TOWERS!
C--------------------------------
      IF(IGAL.EQ.0)THEN
        ALP=7.8E-4
        DELTA=1.-4.*ALP*(E4CLU(IT)/XE4100)
        IF ( DELTA.GT.0.00001) THEN
          DELTA=SQRT(DELTA)
          DIFF=((1.-DELTA)/(2.*ALP))*XE4100-E4CLU(IT)
          E4CLU(IT)=E4CLU(IT)+DIFF
        ENDIF
      ENDIF
C--------------------------------
      XE4=E4CLU(IT)/PTTP
C     RESOLUTION
      RESO=SQRT((RESP2*XE4100**2)/PTTP**2+RESE2/PTTP**2)
C     ESTIMATOR
      R2ESTI(IT)=(XE4-XE4100)/RESO
C     PREPARE VARIABLES FOR LONGITUDINAL ANALYSIS
      E4STK3(IT)=0
      E4STK2(IT)=0
      E4STK1(IT)=0
      XB11=0.
      XB21=0.
      XB31=0.
      XB12=0.
      XB22=0.
      XB32=0.
      XB13=0.
      XB23=0.
      XB33=0.
      XB1=0.
      XB2=0.
      XB3=0.
      ERAW=0.
      KK1=NBE4ST(IT)
      DO 1 KK=1,KK1
      IF(KSTO(IT,KK).EQ.3)THEN
      XB13=XB13+ESTO(IT,KK)*XSTO(IT,KK)
      XB23=XB23+ESTO(IT,KK)*YSTO(IT,KK)
      XB33=XB33+ESTO(IT,KK)*ZSTO(IT,KK)
      E4STK3(IT)=ESTO(IT,KK)+E4STK3(IT)
      ENDIF
      IF(KSTO(IT,KK).EQ.2)THEN
      XB12=XB12+ESTO(IT,KK)*XSTO(IT,KK)
      XB22=XB22+ESTO(IT,KK)*YSTO(IT,KK)
      XB32=XB32+ESTO(IT,KK)*ZSTO(IT,KK)
      E4STK2(IT)=ESTO(IT,KK)+E4STK2(IT)
      ENDIF
      IF(KSTO(IT,KK).EQ.1)THEN
      XB11=XB11+ESTO(IT,KK)*XSTO(IT,KK)
      XB21=XB21+ESTO(IT,KK)*YSTO(IT,KK)
      XB31=XB31+ESTO(IT,KK)*ZSTO(IT,KK)
      E4STK1(IT)=ESTO(IT,KK)+E4STK1(IT)
      ENDIF
C 4 CENTERED STOREYS BARYCENTER
      XB1=XB1+ESTO(IT,KK)*XSTO(IT,KK)
      XB2=XB2+ESTO(IT,KK)*YSTO(IT,KK)
      XB3=XB3+ESTO(IT,KK)*ZSTO(IT,KK)
      ERAW=ERAW+ESTO(IT,KK)
 1    CONTINUE
      XBARY1(IT)=XB1/ERAW
      XBARY2(IT)=XB2/ERAW
      XBARY3(IT)=XB3/ERAW
      IF(E4STK1(IT).NE.0)THEN
      XB11=XB11/E4STK1(IT)
      XB21=XB21/E4STK1(IT)
      XB31=XB31/E4STK1(IT)
      ENDIF
      IF(E4STK2(IT).NE.0)THEN
      XB12=XB12/E4STK2(IT)
      XB22=XB22/E4STK2(IT)
      XB32=XB32/E4STK2(IT)
      ENDIF
      IF(E4STK3(IT).NE.0)THEN
      XB13=XB13/E4STK3(IT)
      XB23=XB23/E4STK3(IT)
      XB33=XB33/E4STK3(IT)
      ENDIF
C
C
C!!!! R1 ESTIMATOR
C
      RESR1=SQRT(RESP2+RESE2)
      R1ESTI(IT)=(ECLU-PTTP)/RESR1
C
C!!!! R3-R4 ESTIMATORS
C
      IF(IOFL.EQ.0)
     &CALL ELONGI(ICLN,NTR,IT,R3ESTI(IT),R4ESTI(IT))
C
C!!!! R5 ESTIMATOR
C
C    GET DE/DX HYPOTHESIS
C
      CALL EIDEDX(NTR,R5ESTI(IT))
      RESTO5=R5ESTI(IT)
C
C
C  RECHERCHE BARYCENTRE
C     CALL EBARYC(ICLN,IT,R6ESTI(IT),R7ESTI(IT),R1ESTI(IT))
      R6ESTI(IT)=1000.
      R7ESTI(IT)=1000.
C!!!! BUILD ELECTRON HYPOTHESIS (WITH R2ESTI R3ESTI R4ESTI )
C
C     IPPO =1 ELECTRON  =0 AUTRE
      IPPOTH(IT)=0
      RACINE=SQRT(R2ESTI(IT)**2+R3ESTI(IT)**2)
      IF((R2ESTI(IT).LE.0..AND.RACINE.LT.3.0).OR.
     &  (R2ESTI(IT).GT.0..AND.R2ESTI(IT).LT.999.0.AND.
     &   ABS(R3ESTI(IT)).LT.3.0))IPPOTH(IT)=1
C
C!!!! GET CORRECTED ECAL ENERGY IF ELECTRON HYPOTHESIS
C  E4CLU(IT) CONTAINS ALL CORRECTIONS ON 2X2 TOWERS
C ECORR IS THEN E4CLU/XE4100
         IF(IPPOTH(IT).EQ.1)ECORR=E4CLU(IT)/XE4100
C!!!! FILL EIDT BANK
C  IEFLAG  IDENTIFICATION QUALITY 0= GOOD 1= CRACK PB =2 OVERLAP
      IEFLAG=0
      CALL EIEFFL(IEFLAG)
      R2=R2ESTI(IT)
      R3=R3ESTI(IT)
      R4=R4ESTI(IT)
      R5=R5ESTI(IT)
      R6=R6ESTI(IT)
      R7=R7ESTI(IT)
      E41=E4STK1(IT)
      E42=E4STK2(IT)
      E43=E4STK3(IT)
      IPP=IPPOTH(IT)
 997   CONTINUE
      R1=R1ESTI(IT)
      CALL EFIEIB(NTR,ICLN)
C
C!!!! PRINT AND HISTOGRAMING
C
      IF(JDBDRF(JULEC).GT.1.AND.IPPOTH(IT).GT.0)THEN
         WRITE(LDEBRL,*)'ELECTRON HYPOTHESIS FOR TRACK NB ',IT,
     &   ' OF CLUSTER NB ',ICLN
      ENDIF
      IF(IPPOTH(IT).GT.0)ITOTE4=ITOTE4+1
C
      IF(JHISRF(JULEC).GE.1)THEN
      CALL HFILL(4901,XE4,PTTP,1.)
      CALL HFILL(4902,R2ESTI(IT),0.,1.)
      CALL HFILL(4903,R2ESTI(IT),R3ESTI(IT),1.)
      ENDIF
CDIFF
      RETURN
 998  CONTINUE
C     NO E ID DONE
      RETURN
 999  CONTINUE
C     MISSING BANK(S)
      RETURN
      END
#endif
@


1.1
log
@Initial revision
@
text
@a0 1
*DK eident
@


1.1.1.1
log
@import julia 300
@
text
@@
