head	1.2;
access;
symbols
	jul313_3:1.2
	jul313_2:1.2
	jul313_1:1.2
	jul313:1.2
	jul312_1:1.2
	jul312:1.2
	jul311:1.2
	jul310_1:1.2
	jul310:1.2
	jul309_1:1.2
	jul309:1.2
	jul308_6:1.2
	jul308_5:1.2
	jul308_4:1.2
	jul308_3:1.2
	jul308_2:1.2
	jul308_1:1.2
	jul308:1.2
	jul307_4:1.2
	jul307_3:1.2
	jul307_2:1.2
	jul307_1:1.2
	jul307:1.2
	jul306_3:1.2
	jul306_2:1.2
	jul306_1:1.2
	jul306:1.2
	jul305_4:1.2
	jul305_3:1.2
	jul305_2:1.2
	jul305_1:1.2
	jul305:1.2
	jul304_3:1.2
	jul304_2:1.2
	jul304_1:1.2
	jul304:1.2
	jul303_7:1.2
	jul303_6:1.2
	jul303_5:1.2
	jul303_4:1.2
	jul303_3:1.2
	jul303_2_mc1:1.2
	jul303_2:1.2
	jul303_1_mc1:1.2
	jul303_1:1.2
	jul303_v:1.2
	jul303:1.2
	jul302_6:1.2
	jul302_5:1.2
	jul302_4:1.2
	jul302_3:1.2
	jul302_2:1.2
	jul302_1:1.2
	jul302:1.2
	jul285_1:1.2
	jul285:1.2
	jul284_1:1.1
	jul284:1.1
	jul283_1:1.1
	jul283:1.1
	jul282_1:1.1
	jul282:1.1
	jul281_3:1.1
	jul281_2:1.1
	jul281_1:1.1
	jul281:1.1
	jul280_1:1.1
	jul280:1.1;
locks; strict;
comment	@c @;


1.2
date	96.12.03.11.02.50;	author cattanem;	state Exp;
branches;
next	1.1;

1.1
date	96.05.06.15.54.49;	author flr;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Julia version 285
@
text
@      SUBROUTINE VUMCTR(IERR)
C---------------------------------------------------------------
C! Unpack vdet history bank
C -  Author: Alain Bonissent (Nov 1994)
C! Modified November 1996 A. Bonissent, handle properly strips which 
C!                                 belong to two clusters (after splitting)
CKEY V_DECK VDET
C--------------------------------------------------------------
C   RETURN CODES: IERR=-1,-2 MISSING BANKS,
C                      -3 : Could not booK VUFK,
C                       0 OK
C-----------------------------------------------------------------
#ifndef DOC
#include "bcs.h"
#include "vcpljj.h"
#include "vdxyjj.h"
#include "vdztjj.h"
#include "vufkjj.h"
C
      PARAMETER(NMAX=10)
      DIMENSION NUMB(2),JHVI(2),NAXYZT(2)
      DIMENSION ITM(NMAX),NSTR(NMAX),QFR(NMAX)
      LOGICAL FIRST
      DATA FIRST/.TRUE./
      SAVE NAFKIN,NAXYZT
C
C  Inline functions
C
#include "bmacro.h"
      IF(FIRST) THEN
         NAFKIN=NAMIND('FKIN')
         NAXYZT(1)=NAMIND('VDZT')
         NAXYZT(2)=NAMIND('VDXY')
         FIRST=.FALSE.
      ENDIF
C
      IERR=0
C
C Delete old existing bank
C
      CALL BDROP(IW,'VUFK')
C
C Get number of VDXY,VDZT hits
C
      NHITS=0
      DO 10 IV=1,2
      KBNK=NAXYZT(IV)
      KBNK=KBNK+1
   11 KBNK=IW(KBNK-1)
      IF(KBNK.GT.0)THEN
         NHITS=NHITS+LROWS(KBNK)
         GO TO 11
      ENDIF
   10 CONTINUE

C
C Get number of FKIN tracks
C
      KFKIN = IW(NAFKIN)
      IF(KFKIN.LE.0) THEN
       IERR=-1
       GOTO 999
      ENDIF
      NTRK = LROWS(KFKIN)
C
C Now that we have the delta rays simulated, some hits may be attached
C to no track, i.e. track 0. Therefore we have one more track than rows
C in the FKIN bank (possibly)
      NTRK=NTRK+1
C
C Create new relations bank with max possible size
C
      NREL = NHITS*NTRK
      NDATA = NREL*LVUFKA+LMHLEN
      CALL AUBOS('VUFK',0,NDATA,KVUFK,IGARB)
      IF(IGARB.GE.2)THEN
         IERR = -3
         GO TO 999
      ELSEIF(IGARB.EQ.1)THEN
       KFKIN = IW(NAFKIN)
      ENDIF
      IW(KVUFK+LMHCOL) = LVUFKA
      IW(KVUFK+LMHROW) = 0
      ITRK0 = 0
      DO 120 IV=1,2
      KBNK=NAXYZT(IV)
      KBNK=KBNK+1
   20 KBNK=IW(KBNK-1)
      IF(KBNK.EQ.0)GO TO 120
         NUMBK = IW(KBNK-2)
         NRVS=NUMBK+IV-1
         NHITS=LROWS(KBNK)
         DO 40 IHIT=1,NHITS
C
C is this hit assocaited to at least one track
C
         IF(IV.EQ.1)THEN
           IASOC = ITABL(KBNK,IHIT,JVDZNA)
         ELSE
           IASOC = ITABL(KBNK,IHIT,JVDXNA)
         ENDIF
C If hit is associated to no FRFT track ...
         IF(IASOC.EQ.0)THEN
            IF(IV.EQ.1)THEN
               NBA = ITABL(KBNK,IHIT,JVDZIW)
               NTZP = ITABL(KBNK,IHIT,JVDZIH)
               QTOT = RTABL(KBNK,IHIT,JVDZPH)
            ELSE
               NBA = ITABL(KBNK,IHIT,JVDXIW)
               NTZP = ITABL(KBNK,IHIT,JVDXIH)
               QTOT = RTABL(KBNK,IHIT,JVDXPH)
            ENDIF
            CALL VTRURL(2,NBA,NTZP,IHIT,
     >                  NRVS,NMAX,NMAT,ITM,NSTR,QFR,IER)
C
C Now, we divide by the total cluster charge, to make percentages
C
            DO III=1,NMAT
               QFR(III)=QFR(III)/QTOT
            ENDDO
            IF(IER.EQ.1)THEN
               IERR=-2
               GO TO 999
            ENDIF
C
C Put info in VUFK bank
C
            DO 70 IMAT=1,NMAT
            NVUFK = LROWS(KVUFK)+IMAT
            KLINE = KROW(KVUFK,NVUFK)
            IW(KLINE+JVUFBN) = NUMBK
            IW(KLINE+JVUFHN) = IHIT
            IW(KLINE+JVUFVI) = IV
            RW(KLINE+JVUFPC) = QFR(IMAT)
            IW(KLINE+JVUFSC) = NSTR(IMAT)
            IW(KLINE+JVUFFK) = ITM(IMAT)
   70       CONTINUE
            IW(KVUFK+LMHROW) = LROWS(KVUFK)+NMAT
         ENDIF
   40    CONTINUE
      GO TO 20
  120 CONTINUE
C
  999 CONTINUE
      CALL AUBPRS('VUFK')
      RETURN
      END
#endif
@


1.1
log
@re-installed jul280 from the historian source because some routines were missing.
@
text
@d5 2
d91 1
d113 2
a114 1
            CALL VTRUTH(2,NBA,NTZP,NMAX,NMAT,ITM,NSTR,QFR,IER)
@
