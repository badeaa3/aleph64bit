head	1.1;
access;
symbols
	bos3589:1.1;
locks; strict;
comment	@c @;


1.1
date	97.01.29.15.49.01;	author flr;	state Exp;
branches;
next	;


desc
@@


1.1
log
@release bos3589: new epio routines
@
text
@      SUBROUTINE EPBOUT(IBUF,IERR)
C. WRITES ONE PHYSICAL BLOCK
C.
C. INPUT:
C.
C. IBUF      BUFFER CONTAINING OUTPUT
C.
C. OUTPUT:
C.
C. IERR      =0  : SUCCESSFUL OPERATION
C.           =2 : WRITE PARITY ERROR
C.           =11 : UNIT NOT DEFINED (IBM)
C.           =12 : WRITE OPERATION FAILED (END OF VOLUME)
*
* epiocom.inc
*
      COMMON/EPCOMM/NMUNIT,NWUNIT,NCONT,ISTART,LASTUT,LREF,LIST(350)
      EQUIVALENCE (NOUTUT,LIST(8))
*
      DIMENSION IL(12),NZERO(2)
*
* wordsize.inc
*
C    number of bits/word
      INTEGER NBITPW, NCHAPW, NBITPC, N16PW
      PARAMETER   (NBITPW=32, NCHAPW=4, NBITPC=8, N16PW=2)
*
      DIMENSION IBUF(2)
      DATA NZERO/2*0/,NEND/65535/
      IERR=0
      NW16=LIST(ISTART+14)
C--- SKIP IF BLOCK IS EMPTY
      IF(NW16.EQ.LIST(ISTART+7))  GOTO 77777
C--- PRESET NO. OF 16 BIT WORDS ACTUALLY WRITTEN
      N16OUT=NW16
C--- GET PAD FLAG
      IPAD=MOD(LIST(ISTART+8),10)
      IF(IPAD.EQ.1)  GOTO 10
      IF(IPAD.EQ.2)  GOTO 20
      GOTO 30
   10 CONTINUE
C--- PAD TO FIXED BLOCK LENGTH
      N16OUT=LIST(ISTART+1)
      GOTO 21
   20 CONTINUE
C--- PAD TO NEXT MAGIC MULTIPLE
      N16OUT=((NW16-1)/LIST(5)+1)*LIST(5)
C--- GET NUMBER OF MACHINE WORDS FOR OUTPUT
   21 NWMACH=(16*N16OUT-1)/LIST(4)+1
      IF(N16OUT.EQ.NW16)  GOTO 31
C--- PAD - FIND FIRST MACHINE WORD TO BECOME ENTIRELY ZERO
      NSMACH=(16*NW16-1)/LIST(4)+2
C--- GET NO. OF TRAILING 16 BIT WORDS IN FRONT OF NSMACH
C--- (PARTIAL OVERLAP POSSIBLE)
C--- 4 ARE SUFFICIENT (UP TO 64 BIT WORDS)
      NPAD=MIN0(4,N16OUT-NW16)
C--- SET TO ZERO
      CALL W16MOV(NZERO,1,IBUF,NW16+1,NPAD)
      IF(NSMACH.LE.NWMACH) CALL UZERO(IBUF,NSMACH,NWMACH)
C--- SET END OF DATA INDICATOR
      CALL BUN16W(NEND,1,IBUF,NW16+1,1)
C--- SET POINTER TO E.O.D. WORD IF NO RECORD START IN THIS BLOCK
      IF(LIST(ISTART+15).EQ.0)  LIST(ISTART+15)=NW16
      GOTO 31
   30 CONTINUE
C--- DO NOT PAD - GET NO. OF MACHINE WORDS
      NWMACH=(16*N16OUT-1)/LIST(4)+1
   31 CONTINUE
C--- INCREASE P.R. COUNT
      LIST(ISTART+11)=LIST(ISTART+11)+1
C--- SPECIFY NECESSARY P.H. CONTROL WORDS
      IF(LIST(ISTART+29).EQ.0)  THEN
*--- 16 bit physical header
         CALL BLO16W(IBUF,1,IL,1,12)
      ELSE
         CALL BLO32W(IBUF,1,IL,1,12)
         CALL CFRIBM(IL,12,2)
      ENDIF
      IL(1)=N16OUT
      IL(2)=LIST(ISTART+7)
      IL(3)=LIST(ISTART+11)
      IL(4)=LIST(ISTART+15)
      IL(5)=LIST(ISTART+4)
      IL(6)=LIST(ISTART+9)
      IL(11)=LIST(ISTART+3)
      IF(LIST(ISTART+29).EQ.0)  THEN
         CALL BUN16W(IL,1,IBUF,1,12)
      ELSE
         CALL CTOIBM(IL,12,2)
         CALL BUN32W(IL,1,IBUF,1,12)
      ENDIF
      LUNIT=LIST(ISTART+10)
*
      IF(LIST(ISTART+33).EQ.1)THEN
        WRITE(LUNIT,REC=LIST(ISTART+11),IOSTAT=IERR)
     1       (IBUF(IWRD),IWRD=1,NWMACH)
*
      ELSE IF(LIST(ISTART+33).EQ.2)THEN
        call cfput(list(istart+25),0,NWMACH,IBUF,IERR)
*
      ELSE
       WRITE(LUNIT,IOSTAT=IERR)(IBUF(IWRD),IWRD=1,NWMACH)
      ENDIF
*
      IF(IERR.GT.0)  IERR=2
      IF(IERR.NE.0)  GOTO 9901
77777 CONTINUE
C--- RESET CONTROL WORDS
      LIST(ISTART+14)=LIST(ISTART+7)
      LIST(ISTART+15)=0
      RETURN
 9901 CONTINUE
C--- ERROR HANDLING
      CALL EPERRH(LIST(ISTART+10),IERR)
      GOTO 77777
      END



@
