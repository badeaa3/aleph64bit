head	1.9;
access;
symbols
	V0060:1.9
	V0059:1.9
	V0058:1.9
	V0057:1.9
	V0056:1.9
	V0055:1.9
	V0054:1.9
	V0053:1.9
	V0052:1.9
	V0051:1.9
	V0050:1.9
	V0049:1.9
	V0048:1.9
	V0047:1.8
	V0046:1.8
	V0045:1.8
	V0044:1.8
	V0043:1.8
	V0042:1.7
	V0041:1.7
	V0040:1.7
	V0039:1.7
	V0038:1.7
	V0037:1.6
	V0036:1.5
	V0035:1.5
	V0034:1.5
	V0033:1.5
	V0032:1.5
	V0031:1.5
	V0030:1.4
	V0029:1.4
	V0028:1.4
	V0027:1.4
	V0026:1.4
	V0025:1.4
	V0024:1.4
	V0023:1.4
	V0022:1.3
	V0021:1.3
	V0020:1.3
	V0019:1.3
	V0018:1.3
	V0017:1.3
	V0016:1.3
	V0015:1.2
	V0014:1.1.1.1
	V0013:1.1.1.1
	V0000:1.1.1.1
	V0001:1.1.1.1
	v1:1.1.1.1
	jacotf:1.1.1;
locks; strict;
comment	@# @;


1.9
date	2000.12.20.11.48.40;	author bonissen;	state Exp;
branches;
next	1.8;

1.8
date	2000.11.07.16.31.36;	author bonissen;	state Exp;
branches;
next	1.7;

1.7
date	2000.10.03.13.03.07;	author bonissen;	state Exp;
branches;
next	1.6;

1.6
date	2000.09.15.09.53.29;	author bonissen;	state Exp;
branches;
next	1.5;

1.5
date	2000.06.05.11.30.26;	author bonissen;	state Exp;
branches;
next	1.4;

1.4
date	2000.03.29.07.43.02;	author bonissen;	state Exp;
branches;
next	1.3;

1.3
date	2000.03.22.16.56.19;	author bonissen;	state Exp;
branches;
next	1.2;

1.2
date	2000.03.22.16.51.27;	author bonissen;	state Exp;
branches;
next	1.1;

1.1
date	2000.03.01.10.29.04;	author flr;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2000.03.01.10.29.04;	author flr;	state Exp;
branches;
next	;


desc
@@


1.9
log
@Use a more stable Oracle web server
@
text
@import java.net.*;               // Network
import java.io.*;         
import java.applet.*;               // Applets 
import java.awt.*;               // ScrollPane, PopupMenu, MenuShortcut, etc..
import java.awt.event.*;         // New event model.
import java.util.*;              // Utilities.
import netscape.security.PrivilegeManager;
public class  oconnect{
  static Frame currentFrame;
  URL u;
  Vector allLines = new Vector(10,1);
  String username, password;
  Enumeration lines;
  String head = "";
  String headsql = "";
  static String pckg = "general_procedures";
//static String oraweb = "http://edmsoraweb.cern.ch:8001/prod_scanbook/owa/";
//static String oraweb = "http://edmsoraweb.cern.ch:8001/prod_scanbook8/owa/";
//static String orawebDev = "http://edmsoraweb.cern.ch:8001/scanbook/owa/";

  static String oraweb = "http://oraweb03.cern.ch:9000/pls/prod_scanbook/";
  static String orawebDev = "http://oraweb03.cern.ch:9000/pls/scanbook/";

  InputStream istr;
  oconnect(String proc){
     if(scanbook.netscaperun){
       try{
	   PrivilegeManager.enablePrivilege("UniversalConnect");
       }
       catch (Exception exc) {
          System.err.println(exc);
       }
     }
     try {
       String strurl = oraweb+pckg+".general";
       if(proc.equals("ImpatientStream")){
        //strurl = "http://alephwww.cern.ch:8080/bonissen-bin/filicards.cgi";
        //strurl="http://alephwww.cern.ch:8080/bonissen-bin/filicards_nrj.cgi";
         strurl="http://alephwww.cern.ch/bonissen-bin/filicards_nrj.cgi";
         u = new URL(strurl);
         scanbook.dbg.out("\nAccess Impatient Stream");
       }else{

  //Progress bar
	   //           pgf = new progressFrame("Transferring data");
	   //           pgf.setValue(0.);

         u = new URL(strurl);
         scanbook.dbg.out("\nexec "+pckg+".general(");
         put_value("procname",proc,false);
	 put_value("user_name",scanbook.userName,false);
         put_value("os_name",scanbook.osName,false);
         put_value("navigator",scanbook.Navigator,false);
         put_value("hardware",scanbook.osArch,false);
         put_value("ip_address",scanbook.ipAddress,false);
	 put_value("ProgVers",scanbook_version.VERSION,false);
       }
     }
     catch (Exception exc) {
        System.err.println("Connect -> "+exc);
	errorMessage msg = new errorMessage(currentFrame,"");
        msg.newline(" Cannot connect to the Oracle web server");
        msg.newline(" Reason : " + exc);
        msg.newline(" Most likely : Network error");
        msg.newline(" Try later");
        msg.display();
      }
  }
    //    void testException() throws Exception{
    //	throw new Exception("Test exception");
    //    }
  public static void setoraweb(String p){
     oraweb = p;
  }
  public static void setPackage(String p){
     pckg = p;
  }
  public static void setCurrentFrame(Frame f){
    currentFrame = f;
  }  
  boolean put_value(){
     return put_value(null,null,false);
  }
  boolean put_value(String name, String value){
     return put_value(name,value,false);
  }
  boolean put_value(String name, String value, boolean end){
    String thisLine;
    boolean wasOK = true;
    if(name != null && value != null){
      String locstr = head+URLEncoder.encode(name)+"="+
                          URLEncoder.encode(value);
      allLines.addElement(locstr);
      scanbook.dbg.out(headsql+name+"=>'"+value+"'");
      head = "&";
      headsql = ",";
    }
    if(end){
      scanbook.dbg.out(");\n");
      head = "";
      headsql = "";
      try {
        URLConnection conn;
        BufferedReader theHTML;
	conn = u.openConnection();
        conn.setDoInput(true);
        conn.setDoOutput(true);
        conn.setUseCaches (false); 
        conn.setRequestProperty
                       ("Content-Type", "application/x-www-form-urlencoded");
	//        conn.setRequestProperty
	//                       ("Connection", "Keep-Alive");
	DataOutputStream str = new DataOutputStream(conn.getOutputStream());
        lines = allLines.elements();
        while (lines.hasMoreElements()){
            thisLine = (String)lines.nextElement();
            scanbook.dbg.out(thisLine);
            str.writeBytes(thisLine);
	}
        str.flush();
        str.close();
	//        System.out.println("Start..5.");
	//	System.out.println("Wait reply");
        allLines.setSize(0);
        boolean first = true;
        if(scanbook.netscaperun){
	    //          System.out.println("Netscaperun");
          try{
	      PrivilegeManager.enablePrivilege("UniversalConnect");
          }
          catch (Exception exc) {
             System.err.println(exc);
          }
        }
	//          System.out.println("Wait reply  1");
          istr = conn.getInputStream();
	  //          System.out.println("Wait reply  1-1");
	  InputStreamReader isrd = new InputStreamReader(istr);
	  //          System.out.println("Wait reply  1-2");
	  theHTML = new BufferedReader (isrd);
	  //               new InputStreamReader(conn.getInputStream()));
	  //          System.out.println("Wait reply 2");
	  errorMessage infos = null;          
readloop:  while ((thisLine = theHTML.readLine()) != null) {
	  scanbook.dbg.out("Receiving "+thisLine);
          if(thisLine.length() >2  && thisLine.startsWith("-9"))
                break readloop;    
          first = false;
          if(first)System.out.println("Receiving ");
	  //	  System.out.println("Receiving "+thisLine);
          if(thisLine.startsWith(
                  "<HEAD><TITLE>Request Failed</TITLE></HEAD>")){
             allLines.addElement("-1 Oracle Error");
             allLines.addElement("-1 Could not connect to Scanbook database");
             allLines.addElement("-1 Please try again later");
             wasOK = false;
             break readloop;
	  }
          if(thisLine.length() >2  && 
           !thisLine.startsWith("Content-type: text/html")){
             String c = thisLine.substring(0,2);
             int index = 0;
             if(!Character.isSpaceChar(thisLine.charAt(0)) &&
                !Character.isSpaceChar(thisLine.charAt(1))){
                index = Integer.parseInt(c.replace('+',' ').trim());
	     }
             if(index == -1){
                 wasOK = false;
             }
             if(index == -2){
		if(infos == null){
	          infos = new errorMessage(currentFrame,"");
                }
                infos.newline(thisLine.substring(2));
	        scanbook.dbg.out(" *DBG : "+thisLine.substring(2));
             }
             
             allLines.addElement(thisLine);
	     //         System.out.println("Receiving "+thisLine);
	     //             pgf.setValue((float)allLines.size()/100.);
	  }
        }
        lines = allLines.elements();
        theHTML.close();
        theHTML = null;
        isrd.close();
        isrd = null;
        istr.close();
        istr = null;
        conn = null;
        scanbook.dbg.out("Input closed.");
        if(infos != null){
	    infos.display();
	}
        if(!wasOK){
	    //	  if(currentFrame == null){
	    //	     currentFrame = new Frame();
	    //	  }
	  errorMessage msg = new errorMessage(currentFrame,"");
          fillError(msg);
          msg.display();
	}
      }
      catch (Exception exc) {
        System.err.println(exc);
        return false;
      }
    }
    return wasOK;
  }
  void sendSelection(fillable f){
     String value = f.getSelection();
     if(value != null){
       put_value(f.getMenuName(),value );
     }
  }
  void fillList(fillable f[]){
     String thisLine;
     String c;
     scanbook.dbg.out("***** Start filling ...");    
//     System.out.println("***** Start filling ...");    
     for( int i=0; i<f.length; i++){
        fillable ff = f[i];
        ff.removeAll();
     }
     while((thisLine = read_line()) != null){
       //	 System.out.println("Parsing*"+thisLine+"*");    
         c = thisLine.substring(0,2);
	 //	 System.out.println("Parsing c = *"+c+"*");    
         int index = Integer.parseInt(c.replace('+',' ').trim());
	 //	 System.out.println("Parsed "+String.valueOf(index));    
         thisLine = thisLine.substring(2);
         boolean select = false;
         if(thisLine.substring(0,1).equals("*")){select = true;}
         boolean enabled = true;
         if(thisLine.substring(0,1).equals("-")){enabled = false;}
         thisLine = thisLine.substring(1);
         if(index >= 0){
	   //           System.out.println("adding "+thisLine);    
           f[index].addItem(thisLine,select,enabled); 
	 }
     }
  }
  void fillListTest(fillable f[]){
     String thisLine;
     String c;
     for( int i=0; i<f.length; i++){
        fillable ff = f[i];
        ff.removeAll();
     }
     for( int i=0; i<f.length; i++){
         f[i].addItem("line1",false,true); 
         f[i].addItem("line2",false,true); 
     }
  }
  void fillList(fillable f){
     f.removeAll();
     String thisLine;
     while((thisLine = read_line()) != null){
       if(!thisLine.startsWith("-")){
         thisLine = thisLine.substring(2);
         boolean select = false;
         if(thisLine.substring(0,1).equals("*")){select = true;}
         boolean enabled = true;
         if(thisLine.substring(0,1).equals("-")){enabled = false;}
         thisLine = thisLine.substring(1);
         f.addItem(thisLine,select,enabled); 
       }
     }
  }
  void fillError(errorMessage errmsg){
      //       System.out.println("fillError");
     String thisLine;
     while((thisLine = read_line()) != null){
	 //         System.out.println("line =>"+thisLine+"-");
         String c = thisLine.substring(0,2);
         int index = Integer.parseInt(c.replace('+',' ').trim());
         if(index == -1 ){
           thisLine = thisLine.substring(2);
           boolean select = false;
           thisLine = thisLine.substring(1);
           errmsg.newline(thisLine);
         }
     }
  }
  String read_line(){ 
    String thisLine;
    while (lines.hasMoreElements()){
        thisLine = (String)lines.nextElement();
        scanbook.dbg.out("read line =>"+thisLine+"-");    
        if(thisLine.length()>0 && 
          !thisLine.startsWith("Content-type: text/html")){
            return thisLine;
	}
     }
     allLines.setSize(0);
     return null;
  }
}




















@


1.8
log
@small improvements
@
text
@d18 6
a23 2
  static String oraweb = "http://edmsoraweb.cern.ch:8001/prod_scanbook8/owa/";
  static String orawebDev = "http://edmsoraweb.cern.ch:8001/scanbook/owa/";
@


1.7
log
@Use port 80 for alephwww
@
text
@d17 3
a19 2
    static String oraweb = "http://edmsoraweb.cern.ch:8001/prod_scanbook/owa/";
    static String orawebDev = "http://edmsoraweb.cern.ch:8001/scanbook/owa/";
@


1.6
log
@Emergency is passed, go back to prod
@
text
@d32 3
a34 2
         //strurl = "http://alephwww.cern.ch:8080/bonissen-bin/filicards.cgi";
         strurl="http://alephwww.cern.ch:8080/bonissen-bin/filicards_nrj.cgi";
@


1.5
log
@Impatient stream by energy
@
text
@a15 1
    //  static String pckg = "scanbook_procedures";
a16 2
    //  static String oraweb = "http://oraweb01.cern.ch:9000/scanbook/owa/";
    //  static String oraweb = "http://edmsoraweb.cern.ch:8001/scanbook/owa/";
a18 1
    //    progressFrame pgf;
@


1.4
log
@small changes
@
text
@d36 2
a37 1
         strurl = "http://alephwww.cern.ch:8080/bonissen-bin/filicards.cgi";
@


1.3
log
@new features, plus colonel (forgotten last time)
@
text
@d22 1
a33 1
	 //	 testException();
d40 5
d147 1
a147 1
	  //          System.out.println("Receiving "+thisLine);
d174 1
d177 1
@


1.2
log
@new features, plus colonel
@
text
@d16 2
a17 1
  static String pckg = "scanbook_procedures";
@


1.1
log
@Initial revision
@
text
@d32 1
a32 1
	 //       String strurl = "http://oraweb01.cern.ch:9000/scanbook/owa/"+
d47 1
d51 7
a57 1
        System.err.println(exc);
d60 3
d134 1
a159 1
                System.out.println(" ********** was OK = false *******");
d162 5
a166 1
	     //         System.out.println(" *DBG : "+thisLine.substring(2));
d181 3
d185 3
a187 3
	  if(currentFrame == null){
	     currentFrame = new Frame();
	  }
a288 2


@


1.1.1.1
log
@ import jscanbook
@
text
@@
