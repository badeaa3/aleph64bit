head	1.3;
access;
symbols
	aleph316_2:1.3
	aleph316_1:1.3
	aleph316:1.3
	aleph315_7:1.3
	aleph315_6:1.3
	aleph315_5:1.3
	aleph315_4:1.3
	aleph315_3:1.3
	aleph315_2:1.3
	aleph315_1:1.3
	aleph315:1.3
	aleph314_2:1.3
	aleph314_1:1.3
	aleph314:1.3
	aleph313_1:1.1.1.1
	aleph313:1.1.1.1
	aleph312_1:1.1.1.1
	aleph312:1.1.1.1
	aleph311_1:1.1.1.1
	aleph311:1.1.1.1
	aleph310_3:1.1.1.1
	aleph310_2:1.1.1.1
	aleph310_1:1.1.1.1
	aleph310:1.1.1.1
	aleph309_1:1.1.1.1
	aleph309:1.1.1.1
	aleph308_3:1.1.1.1
	aleph308_2:1.1.1.1
	aleph308_1:1.1.1.1
	aleph308:1.1.1.1
	aleph307_6:1.1.1.1
	aleph307_5:1.1.1.1
	aleph307_4:1.1.1.1
	aleph307_2:1.1.1.1
	aleph307_1:1.1.1.1
	aleph307:1.1.1.1
	aleph306:1.1.1.1
	aleph305_4:1.1.1.1
	aleph305_3:1.1.1.1
	aleph305_2:1.1.1.1
	aleph305_1:1.1.1.1
	aleph305:1.1.1.1
	aleph304_5:1.1.1.1
	aleph304_4:1.1.1.1
	aleph304_3:1.1.1.1
	aleph304_2:1.1.1.1
	aleph304_1:1.1.1.1
	aleph304:1.1.1.1
	aleph303_3:1.1.1.1
	aleph303_2:1.1.1.1
	aleph303_1_mc1:1.1.1.1
	aleph303_1:1.1.1.1
	aleph303:1.1.1.1
	aleph302_9:1.1.1.1
	aleph302_8:1.1.1.1
	aleph302_7:1.1.1.1
	aleph302_6:1.1.1.1
	aleph302_5:1.1.1.1
	aleph302_4:1.1.1.1
	aleph302_3:1.1.1.1
	aleph302_2:1.1.1.1
	aleph302_1:1.1.1.1
	aleph302:1.1.1.1
	aleph216:1.1.1.1
	aleph215_3:1.1.1.1
	aleph215_2:1.1.1.1
	aleph215:1.1.1.1
	aleph214:1.1.1.1
	aleph213:1.1.1.1
	aleph212:1.1.1.1
	ALEPH212:1.1.1;
locks; strict;
comment	@c @;


1.3
date	99.12.08.16.28.29;	author cattanem;	state Exp;
branches;
next	1.2;

1.2
date	99.12.07.17.05.37;	author flr;	state Exp;
branches;
next	1.1;

1.1
date	96.02.07.11.42.41;	author flr;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	96.02.07.11.42.42;	author flr;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Alephlib 314, including y2k fixes
@
text
@      SUBROUTINE HRHTUB(IER)
C----------------------------------------------------------------------
C
CKEY MUONID HCAL EFFICIENCY / INTERNAL
C
C!  - Remake the HTUB bank based on HCAL tube efficiencies observed
C!    in the data
C!
C!   Author   :- D.Cinabro             20-MAY-1990
C!               G.Taylor              10-APR-1992
C!               Changed to have map for all monte carlo samples
C!               to allow easy incorpoation of MC changes
C!               Change grouping of HCAL layers
C!               G.Taylor              10-APR-1992
C!               map efficiency using HDTE c/w HTEF
C!               ie use modules c/w supermodules
C!               M.Cattaneo            08-DEC-1999
C!               y2k fix: ASIM can be yyyymm, HZEF,HDTE can have NR>99
C!
C!   Inputs: HTUB bank
C!   Outputs: Remade HTUB bank
C!            IER /I Error flag
C!                    = 0 ok
C!                    = 1 old galeph version
C!                    = 2 no ASIM bank
C!                    = 3 year not in range 1990-1994
C!                    = 6 no HTUB bank
C!                    = 7 bos garbage collection
C!
C!======================================================================
#ifndef DOC
#include "htubjj.h"
#include "rhahjj.h"
#include "bcs.h"
      INTEGER ALGTDB,JUNIDB
      CHARACTER CHAINT*4
      DATA IERROR/0/
#include "bmacro.h"
C-----------------------------------------------------------------------
C
C Check on GALEPH version used in production
C
      IER=0
      KRHAH = IW(NAMIND('RHAH'))
      KAJOB = IW(NAMIND('AJOB'))
      IVER = 0
      JVER =-1
      DO 3 IST = 1,LROWS(KRHAH)
        IF (CHAINT(ITABL(KRHAH,IST,JRHAPN)).EQ.'GALE')
     &      IVER = ITABL(KRHAH,IST,JRHAPV)
C Write the Julia version in JVER: if Galeph file JVER=-1
        IF (CHAINT(ITABL(KRHAH,IST,JRHAPN)).EQ.'JULI')
     &      JVER = ITABL(KRHAH,IST,JRHAPV)
C
    3 CONTINUE
      IF (IVER.EQ.0.AND.KAJOB.GT.0) IVER = ITABL(KAJOB,1,9)
      IF (IVER.LT.237) THEN
        IF (IW(6).GT.0)
     &  WRITE(IW(6),*) ' *** HRHTUB - Galeph versions < 237 are not ',
     &    ' supported by MUIDO '
        IER=1
        RETURN
      ELSEIF (IVER.LT.241) THEN
C used for 1990 production
        IMCEF=1
      ELSE
C used for 1991 production
        IMCEF=2
      ENDIF
C now find out which year to simulate
      KASIM = IW(NAMIND('ASIM'))
      IF (KASIM.LE.0) THEN
        IF (IW(6).GT.0)
     &  WRITE(IW(6),*) ' ERROR : HRHTUB - NO ASIM BANK ON THIS MC '
        IER=2
        RETURN
      ELSE
        IDEF=(ITABL(KASIM,1,1)/100)
C +y2k
        IF( IDEF .GT. 1900 ) IDEF = IDEF - 1900
        IF (IDEF.LT.90.OR.IDEF.GT.110) THEN
C -y2k
          IF(IW(6).GT.0)
     &    WRITE(IW(6),*) ' ERROR : HRHTUB - FUNNY YEAR IN ASIM '
          IER=3
          RETURN
        ENDIF
      ENDIF
C
      KHDTEM=MDARD(IW,JUNIDB(0),'HDTE',IMCEF)
      IF(KHDTEM.LE.0) THEN
        IF (IW(6).GT.0.AND.IERROR.EQ.0) THEN
         WRITE(IW(6),*) ' ###################################### '
         WRITE(IW(6),*) ' HRHTUB : ERROR - HDTE BANK NUMBER ',IMCEF,
     &      ' NOT ON THE DATABASE'
         WRITE(IW(6),*) ' HRHTUB : IN this case the HCAL efficiency'
         WRITE(IW(6),*) ' HRHTUB : treatment will not be applied, you'
         WRITE(IW(6),*) ' HRHTUB : will get fully efficient monte carlo'
         WRITE(IW(6),*) ' HRHTUB : Proceed with care........ '
         WRITE(IW(6),*) ' ###################################### '
         IERROR=IERROR+1
        ENDIF
        IER=4
        RETURN
      ENDIF
      KHDTED=MDARD(IW,JUNIDB(0),'HDTE',IDEF)
      IF(KHDTED.LE.0) THEN
        IF (IW(6).GT.0.AND.IERROR.EQ.0) THEN
         WRITE(IW(6),*) ' ###################################### '
         WRITE(IW(6),*) ' HRHTUB : ERROR - HDTE BANK NUMBER ',IDEF,
     &      ' NOT ON THE DATABASE'
         WRITE(IW(6),*) ' HRHTUB : IN this case the HCAL efficiency '
         WRITE(IW(6),*) ' HRHTUB : treatment will not be applied, you'
         WRITE(IW(6),*) ' HRHTUB : will get fully efficient monte carlo'
         WRITE(IW(6),*) ' HRHTUB : Proceed with care... '
         WRITE(IW(6),*) ' ###################################### '
         IERROR=IERROR+1
        ENDIF
        IER=5
        RETURN
      ENDIF
C
C Want to have full efficiency in HTUB 1 and no HTUB 0
C
      KHTUB = NLINK('HTUB',1)
      IF (KHTUB.LE.0) THEN
        KHTUB=NSWAP('HTUB',0,'HTUB',1)
        IF (KHTUB.LE.0) THEN
C         WRITE(6,*) ' ERROR : HRHTUB - No HTUB bank on input file'
          IER=6
          RETURN
        ENDIF
      ELSE
        IND=NDROP('HTUB',0)
      ENDIF
C
      CALL AUBOS('HTUB',0,IW(KHTUB),KHTUB0,IGARB)
      IF(IGARB.EQ.2) THEN
        IDUM=NSWAP('HTUB',0,'HTUB',1)
        IER=7
        RETURN
      ELSE IF(IGARB.EQ.1) THEN
        KHTUB=NLINK('HTUB',1)
        KHDTEM=NLINK('HDTE',IMCEF)
        KHDTED=NLINK('HDTE',IDEF)
      ENDIF
      IW(KHTUB0+1)=IW(KHTUB+1)
      IW(KHTUB0+2)=IW(KHTUB+2)
C
C Look for HLTU banks
C
      KHLTU=NLINK('HLTU',0)
      IF(KHLTU.NE.0) THEN
       NUMRND=LROWS(KHLTU)+LROWS(KHTUB)
      ELSE
       NUMRND=LROWS(KHTUB)
      ENDIF
C
C Look for HZEF bank in database otherwise  usual mapping
C
      KHZEF=MDARD(IW,JUNIDB(0),'HZEF',IDEF)
      IF(KHZEF.LE.0) KHLTU=0
C
C Protection against corrupted HLTU bank (ALPHA job AND Julia < 271)
C
      JALPV=NLINK('ALPV',0)
      IF(JALPV.GT.0.AND.JVER.GT.0.AND.JVER.LE.270) THEN
        IF(IW(6).NE.0.AND.IERROR.EQ.0) THEN
          WRITE(IW(6),*) 'HRHTUB: You are trying to redo extrapolation'
          WRITE(IW(6),*) 'HRHTUB: inside an ALPHA job using MC data '
          WRITE(IW(6),*) 'HRHTUB: processed with JULIA < 271:'
          WRITE(IW(6),*) 'HRHTUB: NO Z-dep. mapping to avoid crash'
          IERROR=IERROR+1
        ENDIF
C
        KHLTU=0
      ENDIF

C
C Loop over the rows of KHTUB
C
      NGOOD = 0
      DO 20 ITUB = 1,LROWS(KHTUB)
        ISUB = ITABL(KHTUB,ITUB,JHTUSN)
        IMOD = ITABL(KHTUB,ITUB,JHTUMN)
        ILAY = ITABL(KHTUB,ITUB,JHTULN)
        IF (ISUB.NE.2) ILAY=ILAY+1
        IF (ISUB.EQ.1) THEN
          IMOD = IMOD
        ELSEIF (ISUB.EQ.2) THEN
          JMOD=IMOD
          IMOD = 6 + IMOD
        ELSE
          IMOD = 30 + IMOD
        ENDIF
        ILAY = (ILAY+2)/2
C Check if we are in the barrel and if HLTU exists
        IF(ISUB.NE.2.OR.KHLTU.LE.0) GOTO 200
C Check if we are in a special module
        IHZRO=0
        DO 140 J=1,LROWS(KHZEF)
         IF(JMOD.EQ.ITABL(KHZEF,J,1).AND.ILAY.LE.ITABL(KHZEF,J,2)) THEN
           IHZRO=J
           GOTO 145
         ENDIF
 140    CONTINUE
        GOTO 200
 145    CONTINUE
C Special module mapping
        DO 150 J=1,LROWS(KHLTU)
         IF(ITABL(KHLTU,J,2).NE.ITUB) GOTO 150
         ZPOS=RTABL(KHLTU,J,1)
C Take into account z sign convention in Galeph
         IF(MOD(JMOD,2).NE.0) ZPOS=-ZPOS
C Compute Z-dependent efficiency
         TEFF=RTABL(KHZEF,IHZRO,3)+
     +        RTABL(KHZEF,IHZRO,4)*ZPOS+
     +        RTABL(KHZEF,IHZRO,5)*ZPOS**2
        CALL ALPROB(1,NUMRND,PROB)
        IF(PROB.LT.TEFF*
     &         RTABL(KHDTED,IMOD,ILAY)/RTABL(KHDTEM,IMOD,ILAY)) THEN

C If at least one is good then the whole cluster is good
          NGOOD = NGOOD + 1
          IPNTO = KROW(KHTUB,ITUB)+1
          IPNTN = KROW(KHTUB0,NGOOD)+1
          CALL UCOPY(IW(IPNTO),IW(IPNTN),LHTUBA)
          GOTO 20
        ENDIF
 150   CONTINUE
C If all the tubes are deleted then the cluster is deleted
       GOTO 20
C
C Usual mapping: End-cap, no supported period, no HLTU , no special mod
C
 200   CONTINUE
C Should it be removed
        CALL ALPROB(1,NUMRND,PROB)
        IF (RTABL(KHDTEM,IMOD,ILAY).LT..001) THEN
          IF (IW(6).GT.0)
     &    WRITE(IW(6),*)' ERROR : QRHTUB - THIS HIT SHOULD NOT BE HERE'
        ELSEIF (PROB/1.01.LT.
     &         RTABL(KHDTED,IMOD,ILAY)/RTABL(KHDTEM,IMOD,ILAY)) THEN
C If not mark it as so in IGOOD array and count in NGOOD
          NGOOD = NGOOD + 1
          IPNTO = KROW(KHTUB,ITUB)+1
          IPNTN = KROW(KHTUB0,NGOOD)+1
          CALL UCOPY(IW(IPNTO),IW(IPNTN),LHTUBA)
        ENDIF
   20 CONTINUE
   21 CONTINUE
C
      IW(KHTUB0+LMHROW) = NGOOD
      IDUM= NBANK('HTUB',0,NGOOD*LHTUBA+LMHLEN)
  999 RETURN
      END
#endif
@


1.2
log
@alephlib 314 - Y2K compliant
@
text
@d17 2
d79 4
a82 2
        IF ((IDEF.LT.90) .OR. (IDEF.GT.99.AND.IDEF.LT.1900) .OR.
     &      (IDEF.GT.2002)) THEN
@


1.1
log
@Initial revision
@
text
@d77 2
a78 1
        IF (IDEF.LT.90.OR.IDEF.GT.99) THEN
@


1.1.1.1
log
@import aleph212 from alws
@
text
@@
