head	1.3;
access;
symbols
	alpha126_22:1.3
	alpha122_22:1.3
	alpha126_21:1.3
	alpha126_20:1.3
	alpha126_19:1.3
	alpha126_18:1.3
	alpha126_17:1.3
	alpha126_16:1.3
	alpha126_15:1.3
	alpha126_14:1.3
	alpha126_13:1.3
	alpha126_12:1.3
	alpha126_11:1.3
	alpha126_10:1.3
	alpha126_09:1.3
	alpha126_08:1.3
	alpha126_07:1.3
	alpha126_06:1.3
	alpha126_05:1.3
	alpha126_04:1.3
	alpha126_03:1.3
	alpha126_02:1.3
	alpha126_1:1.3
	alpha125_17:1.3
	alpha125_16:1.3
	alpha125_15:1.3
	alpha125_14:1.3
	alpha125_13:1.3
	alpha125_12:1.3
	alpha125_11:1.3
	alpha125_10:1.3
	alpha125_09:1.3
	alpha125_08:1.3
	alpha125_07:1.3
	alpha125_06:1.3
	alpha125_05:1.3
	alpha125_04:1.2
	alpha125_03:1.1;
locks; strict;
comment	@c @;


1.3
date	2000.04.05.14.12.34;	author boucrot;	state Exp;
branches;
next	1.2;

1.2
date	2000.04.05.13.56.48;	author boucrot;	state Exp;
branches;
next	1.1;

1.1
date	2000.03.07.07.22.01;	author boucrot;	state Exp;
branches;
next	;


desc
@@


1.3
log
@*** empty log message ***
@
text
@      SUBROUTINE QMSTCLR
C ----------------------------------------------------------------------
C! Stage clear all tapes/files from 'FILI' cards if SCLR card present
C  J. Boucrot        14-Feb-2000
C  Called from QMTERM
C  Calls ALSTIN,BKINCA                          from ALEPHLIB
C  Input bank needed :  'FILI'  ( from BOS data cards )
C ----------------------------------------------------------------------
#ifndef DOC
#include "bcs.h"
#if defined(UNIX)
      PARAMETER ( MAXFI = 999 , LUNQR = 98 , NMUSD = 2 )
      INTEGER BKINCA
      CHARACTER TAPE*6,CARTF*200,FILEX*5
      character comand*100,comqry*100,fiqry*50,qrlin*100
C ----------------------------------------------------------------------
C Execute only if the is a "SCLR" data card:
      IF (IW(NAMIND('SCLR')).LE.0) GO TO 999
      WRITE (IW(6),1200)
C
C LOOP on all 'FILI' data cards, if any
C
      JFILI=NAMIND('FILI')+1
 100  JFILI=IW(JFILI-1)
      IF (JFILI.LE.0) GO TO 800
      NDAFI=IW(JFILI)
      IF (NDAFI.LE.0) GO TO 100
      TAPE=' '
      FILEX=' '
      IFILE=0
C Translate into character string ans get tape and file number:
      CALL ALSTIN(IW(JFILI+1),NDAFI,CARTF)
      CALL QANFILI(CARTF,TAPE,FILEX)
C Tape and file found:
C
      IFILE=BKINCA(FILEX)
      IF (TAPE.EQ.' '.OR.FILEX.EQ.' '.OR.IFILE.gt.MAXFI) THEN
         WRITE (IW(6),1234) TAPE,IFILE
         GO TO 100
      ENDIF
C
C Determine the number of times this file was used in the stageing pool:
C The parameter -u in the stageqry command ensures that only tape/files
C staged by the owner of the present job are checked
C
      fiqry=' '
      fiqry='stageqry.output'
      lqry=lnblnk(fiqry)
      call system(' rm -f '//fiqry(1:lqry))
      comqry=' '
      comqry=' stageqry -V '//tape//' -u -q '//filex(1:lnblnk(filex))//
     +       ' > '//fiqry(1:lqry)
      call system(comqry(1:lnblnk(comqry)))
      call aopen(lunqr,fiqry,'CARDS','DISK',IER)
      if (ier.ne.0) go to 100
      rewind (lunqr)
      ilin=0
      iused=0
 400  read (lunqr , '(A)' , err=500, end =500  ) qrlin
      ilin=ilin+1
      if (ilin.eq.1) go to 400
      read (qrlin,1300) iused
 500  continue
      close (lunqr)
      call system(' rm -f '//fiqry(1:lqry))
C This tape was staged by another user : it will not be stage cleared:
      if (ilin.le.1) then 
         write (iw(6),1302) tape,filex
         go to 100
      endif
C
C If this tape/file is not staged,
C or has been used more than nmusd times,
C don't erase it from the stage pool:
C
      if (iused.gt.nmusd) then
         write (iw(6),1301) tape,filex,iused
         go to 100
      endif
C
C Otherwise ...
C Stageclear this tape/file :
C
      comand=' '
      comand=' stageclr -V '//tape//' -q '//filex(1:lnblnk(filex))
      write (iw(6),1201) comand(1:lnblnk(comand))
      call system(comand(1:lnblnk(comand)))
      go to 100
C
C All finished:
C
 800  continue
#endif
 999  RETURN
C
 1200 FORMAT (/' _QMSTCLR_ Data card SCLR present:',
     +         ' try to stage clear all files from FILI cards'/)
 1201 FORMAT (' _QMSTCLR_ Command executed: ',2x,(A))
 1234 FORMAT (' _QMSTCLR_ Error: Unexpected tape, file =',2x,a6,i8)
 1300 FORMAT (50X,i4)
 1301 FORMAT (' _QMSTCLR_ tape/file =',2x,a6,2x,a3,' no stageclr ',
     +        'done : nb of uses =',i5)
 1302 FORMAT (' _QMSTCLR_ tape/file =',2x,a6,2x,a3,' no stageclr ',
     +        'done : owned by somebody else')
      END
#endif
@


1.2
log
@*** empty log message ***
@
text
@d37 1
a37 1
      IF (TAPE.EQ.' '.OR.FILE.EQ.' '.OR.IFILE.gt.MAXFI) THEN
@


1.1
log
@*** empty log message ***
@
text
@d12 1
a12 1
      PARAMETER ( MAXFI = 999 , LUNQR = 98)
d14 1
a14 1
      CHARACTER TAPE*6,CARDF*80,CARTF*80,SUBF*80,FILEX*5
a19 2
 1200 FORMAT (/' _QMSTCLR_ Data card SCLR present:'
     +         '           Cleaning of all files from FILI cards'/)
d31 1
a31 1
C Translate into character string :
d33 1
a33 36
      CARDF=' '
      CARDF=CARTF
      CALL CLTOU(CARDF)
      LN=LNBLNK(CARDF)
      IF (LN.EQ.0) GO TO 100
C
C Is it a 'FILI' card with 'CART Y0XXXX.ZZZ' syntax ?
C
      ICART=INDEX(CARDF,'CART ')
      IF (ICART.EQ.0) GO TO 200
      IDSL=INDEX(CARDF,'.SL ')
      IF (IDSL.EQ.0) IDSL=INDEX(CARDF,'.AL ')
      IF (IDSL.EQ.0) IDSL=INDEX(CARDF,'.UL ')
      IF (IDSL.EQ.0) IDSL=INDEX(CARDF,'.NL ')
      IF (IDSL.EQ.0) GO TO 100
      SUBF=CARDF(ICART+4:IDSL-1)
      LL=LNBLNK(SUBF)
      ITAP=ICFNBL(SUBF,1,LL)
      IF (ITAP.LE.0) GO TO 100
      IDOT=INDEX(SUBF,'.')
      IF (IDOT.LE.0) GO TO 100
      TAPE=SUBF(ITAP:IDOT-1)
      FILEX=SUBF(IDOT+1:LL)
      GO TO 300
C
C Is it a 'FILI' card with 'r0xxxx_yyy.edir' syntax ?
C
 200  IEDIR=INDEX(CARTF,'.edir')
      IF (IEDIR.EQ.0) GO TO 100
      LSUB=IEDIR-1
      SUBF(1:)=CARDF(1:LSUB)
      INDUN=INDEX(SUBF,'_')
      IF (INDUN.EQ.0) GO TO 100
      TAPE=SUBF(indun-6:INDUN-1)
      FILEX=SUBF(INDUN+1:LSUB)
C
d36 2
a37 2
 300  IFILE=BKINCA(FILEX)
      IF (IFILE.gt.MAXFI) THEN
a38 1
 1234    FORMAT (' _QMSTCLR_ Error: Unexpected tape, file =',2x,a6,i8)
d43 2
d46 1
a46 1
      fiqry=' '             
d48 1
a48 1
      lqry=lnblnk(fiqry) 
d51 2
a52 2
      comqry=' stageqry -V '//tape//' -q '//filex(1:lnblnk(filex))//      
     +       ' > '//fiqry(1:lqry) 
d62 1
a62 2
      read (qrlin,1300) iused  
 1300 format (50x,i4)
d66 5
d72 2
a73 2
C If this tape/file is not staged, 
C or has been used more than once,
d76 1
a76 1
      if (iused.ne.1) then 
a77 2
 1301    format (' _QMSTCLR_ tape/file =',2x,a6,2x,a3,' no stageclr ',
     +           'done : nb of uses =',i5) 
d79 1
a79 1
      endif 
a86 1
 1201 format (' _QMSTCLR_ Command executed: ',2x,(A))
d95 10
@

