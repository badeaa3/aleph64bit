head	1.8;
access;
symbols
	alpha126_22:1.8
	alpha122_22:1.8
	alpha126_21:1.7
	alpha126_20:1.7
	alpha126_19:1.7
	alpha126_18:1.7
	alpha126_17:1.6
	alpha126_16:1.5
	alpha126_15:1.5
	alpha126_14:1.4
	alpha126_13:1.4
	alpha126_12:1.4
	alpha126_11:1.4
	alpha126_10:1.4
	alpha126_09:1.4
	alpha126_08:1.3
	alpha126_07:1.3
	alpha126_06:1.3
	alpha126_05:1.3
	alpha126_04:1.3
	alpha126_03:1.3
	alpha126_02:1.2
	alpha126_1:1.1;
locks; strict;
comment	@c @;


1.8
date	2003.09.10.08.03.23;	author alphy;	state Exp;
branches;
next	1.7;

1.7
date	2002.10.11.06.25.26;	author alphy;	state Exp;
branches;
next	1.6;

1.6
date	2002.09.24.07.28.48;	author alphy;	state Exp;
branches;
next	1.5;

1.5
date	2002.01.31.13.38.13;	author alphy;	state Exp;
branches;
next	1.4;

1.4
date	2001.06.06.05.52.02;	author boucrot;	state Exp;
branches;
next	1.3;

1.3
date	2000.12.20.17.03.21;	author boucrot;	state Exp;
branches;
next	1.2;

1.2
date	2000.12.12.07.28.23;	author boucrot;	state Exp;
branches;
next	1.1;

1.1
date	2000.11.21.08.46.59;	author boucrot;	state Exp;
branches;
next	;


desc
@@


1.8
log
@*** empty log message ***
@
text
@      SUBROUTINE QRKSEC
C----------------------------------------------------------------------
C get the generated cross-section from bank RKSE
C for the ru presently analyzed, 
C and for the whole dataset
C results are transmitted into the common /XKSECS/
C Author J. Boucrot 26-10-2000
C Mod J. Boucrot 31-01-2002 fix for same Ranmar seeds
C Mod B. Bloch   24-09-2002 fix for banks on the ADBSCONS DAF
C Mod J. Boucrot 11-10-2002 replace Kingal code 5030 by 5300
C----------------------------------------------------------------------
#include "qcde.h"
#include "krunjj.h"
#include "rksejj.h"
#include "asimjj.h"
#include "krsktrg.h"
#include "rhahjj.h" 
C-----------------------------------------------------------------------
      save
      external chaint
      parameter ( nrumm = 2000, ikrco = 10000, irma = 100000)
      parameter ( kinor = 5030 , kinok = 5300)
      common / XKSECS / xsecru,xseceru,nevpro,xsecpr,xsecepr
      character chaint*4,prog*4,title*48,zkey*60,ckey*60,tcp*12,tap*12
      data irun / -1 /
#include "bmacro.h"
C-----------------------------------------------------------------------
      call qfkirev
      IF (KRUN.GT.NRUMM) GO TO 999
      XSEC=-1.
      XSECE=0.
      NEVPR=0
      kinco=0
      XSECP=0.
      XSECPE=0.
      XSECR=0.
      XSECRE=0.
      NEVTP=0
      NSETS=0
      TITLE=' ' 
      ZKEY=' '
      CKEY=' '
      IF (KRUN.NE.IRUN) THEN
         XSECRU=-1.
         XSECERU=-1.
         NEVPRO=0
         XSECPR=-1.
         XSECEPR=-1.
      ENDIF
C Find run number, first/last ranmar seed of dataset:
      IKRU=IW(NAMIND('KRUN'))
      IF (IKRU.GT.0) THEN
         KKRU=KROW(IKRU,1)
         KOD=IW(KKRU+JKRUGI)
         KINCO=MOD(KOD,IKRCO)
C For historical reasons, Kingal code 5030 must be 
C relaced by Kingal code 5300 for RKSE banks:
         if (kinco.eq.kinor) kinco=kinok 
         IRAN1=IW(KKRU+JKRUFS)
         IRAN2=IW(KKRU+JKRUSS)
         CALL ALSTIN(IW(KKRU+JKRURT),JKRUFS-JKRURT,TITLE)
      endif
C Tape name:
      tcp=' '
      lcp=0
      if (nrukin.gt.0) then
         tcp=filrlis(nrukin) 
         call cltou(tcp)
         lcp=lnblnk(tcp) 
      endif      
C KINGAL code found: look for 'RKSE' bank:
      if (kinco.EQ.0) GO TO 999
      JRKSE=NLINK('RKSE',KINCO)
C -------------- banks may be on ADBSCONS.DAF 
      if (JRKSE.EQ.0) then
C try load from dbase if not in dbas.bank
         LDBAS = JUNIDB(0)
         JBRKSE = NDANR (LDBAS,'RKSE','EQ',kinco)
         if(JBRKSE.ne.0) ind = mdard(iw,ldbas,'RKSE',kinco)
         JRKSE=NLINK('RKSE',KINCO)
      endif
      IF (JRKSE.EQ.0) GO TO 999
C Find year of GALEPH geometry:
      IKAP=IW(NAMIND('ASIM'))
      IF (IKAP.NE.0) THEN
C Year/version of GALEPH Geometry in ASIM :
C was previously yyvv, may become yyyyvv
         IDASI=ITABL(IKAP,1,JASIYM)
         IF (IDASI.GT.IRMA) THEN
            IYEOG=IDASI/100
         ELSE                     
            IYY=IDASI/100
            IF (IYY.GT.10) THEN
               IYEOG=1900+IYY
            ELSE
               IYEOG=2000+IYY
            ENDIF
         ENDIF  
      ENDIF
C Find the LEP centre-of-mass energy in MeV:
      IELEP=NINT(1000.*ALELEP(KRUN))
C Find nature of data, Galeph/Julia/MINI versions:
      igver=0
      ijver=0
      imver=0
      JRHAH=IW(NAMIND('RHAH'))
      DO 100 IRHAH=1,LROWS(JRHAH)
         KRHAH=KROW(JRHAH,IRHAH)
         INDAT=IW(KRHAH+JRHANO)
         PROG=CHAINT(IW(KRHAH+JRHAPN))
         IF (PROG(1:1).EQ.'G') IGVER=IW(KRHAH+JRHAPV)
         IF (PROG(1:1).EQ.'J') IJVER=IW(KRHAH+JRHAPV)
         IF (PROG(1:1).EQ.'M') IMVER=IW(KRHAH+JRHAPV)
 100  CONTINUE
C 'RKSE' bank exists: look for the dataset
      DO 200 IRKSE=1,LROWS(JRKSE)
         KRKSE=KROW(JRKSE,IRKSE)
C check the tape name:
         call alstin(iw(krkse+jrksvs),3,tap)
         call cltou(tap)
         ltap=lnblnk(tap)
         if (lcp.gt.0) then
            if (ltap.ne.lcp) go to 200
            if (tap(1:ltap).ne.tcp(1:lcp)) go to 200
         endif
         IF (IYEOG.NE.IW(KRKSE+JRKSYG)) GO TO 200
         IF (INDAT.NE.IW(KRKSE+JRKSND)) GO TO 200
         IF (IELEP.NE.IW(KRKSE+JRKSLE)) GO TO 200
         IF (IGVER.NE.IW(KRKSE+JRKSGV)) GO TO 200
         IF (XMINI.AND.IMVER.NE.IW(KRKSE+JRKSMV)) GO TO 200
         IF (IRAN1.NE.IW(KRKSE+JRKSR1)) GO TO 200
         IF (IRAN2.NE.IW(KRKSE+JRKSR2)) GO TO 200
         IF (KRUN.NE.IW(KRKSE+JRKSRN)) GO TO 200 
         IF (IW(KRKSE+JRKSLT).NE.0) GO TO 200
C Dataset found: give Xsec, Xsece, ZKEY,
C then the prod. cross section and error, and flag this row:
         XSEC=RW(KRKSE+JRKSKX)
         XSECE=RW(KRKSE+JRKSKE)
         NEVPR=IW(KRKSE+JRKSNE)
         CALL ALSTIN(IW(KRKSE+JRKSKW),LRKSEA-JRKSKW+1,ZKEY)
         xsecp=rw(krkse+jrkspx)
         xsecpe=rw(krkse+jrkspe)
         IW(KRKSE+JRKSLT)=1
         go to 250
 200  CONTINUE
C---------------------------------------------------------------------
C get the total number of events from all runs of the production:
C and the corresponding cross-section and error:
C
 250  xsecr=0. 
      xsecre=0.
      CKEY=' '
      DO 300 IRKSE=1,LROWS(JRKSE)
         KRKSE=KROW(JRKSE,IRKSE)
         IF (IYEOG.NE.IW(KRKSE+JRKSYG)) GO TO 300
         IF (INDAT.NE.IW(KRKSE+JRKSND)) GO TO 300
         IF (IELEP.NE.IW(KRKSE+JRKSLE)) GO TO 300
         IF (IGVER.NE.IW(KRKSE+JRKSGV)) GO TO 300
         IF (XMINI.AND.IMVER.NE.IW(KRKSE+JRKSMV)) GO TO 300
         CALL  ALSTIN(IW(KRKSE+JRKSKW),LRKSEA-JRKSKW+1,CKEY)
         IF (CKEY(1:LNBLNK(CKEY)).NE.ZKEY(1:LNBLNK(ZKEY))) GO TO 300
C Store X-section and Nevents for all runs of this prod:
         NSETS=NSETS+1
         NEVTP=NEVTP+IW(KRKSE+JRKSNE)
         XSECR=XSECR+RW(KRKSE+JRKSKX)
         XSECRE=XSECRE+RW(KRKSE+JRKSKE)
 300  CONTINUE
C ---------------------------------------------------------------------
C Now printout the results and store them at the beginning of a new run:
C
 500  CONTINUE
      if (krun.ne.irun) then
         irun=krun
         ltit=lnblnk(title)
         XSECRU=-1.
         XSECERU=-1.
         NEVPRO=0
         XSECPR=-1.
         XSECEPR=-1.
         if (xsec.gt.0.) then 
            xsecru=xsec
            xseceru=xsece
            nevpro=nevtp
            fset=float(nsets)
            xsect=0.
            xsecte=0.
            if (nsets.gt.0) then 
               xsect=xsecr/fset
               xsecte=xsecre/(fset*sqrt(fset))             
            endif
C Choose if one uses the prod cross section from 'RKSE' or the one
C from the average of runs:           
            if (xsecp.gt.0.) then
               xsecpr=xsecp 
               xsecepr=xsecpe
               iprov=1
            else
               xsecpr=xsect
               xsecepr=xsecte
               iprov=2
            endif
C           
            write (iw(6),1234) krun,title(1:ltit),xsecru,xseceru,
     +                         nevpr,nsets,nevpro,xsecpr,xsecepr
 1234       format (/1x,100(1H*)/5x,'==> New run :',i5,
     +          2x,'** Title of production =',2x,(A)/
     +          5x,'==> Cross-section for this run =',
     +          f12.5,' +/- ',f10.5,' picobarns',/5x,
     +          '==> Number of events in this run =',I6/
     +          5x,'--> This is part of a production of ',i5,
     +          ' runs with Nevents =',i8/ 
     +          5x,'==> Cross-section for the whole production =',
     +          f12.5,' +/- ',f10.5,' picobarns',/
     +          1x,100(1H*)/)
         endif
      endif
c  
 999  continue
      RETURN
      END
@


1.7
log
@*** empty log message ***
@
text
@d208 1
a208 1
     +          f10.5,' +/- ',f10.5,' picobarns',/5x,
d213 1
a213 1
     +          f10.5,' +/- ',f10.5,' picobarns',/
@


1.6
log
@*** empty log message ***
@
text
@d8 3
d22 1
d56 3
@


1.5
log
@*** empty log message ***
@
text
@d67 8
@


1.4
log
@*** empty log message ***
@
text
@d13 1
d18 1
a18 1
      parameter ( nrumx = 2000, ikrco = 10000, irma = 100000)
d20 1
a20 1
      character chaint*4,prog*4,title*48,zkey*60,ckey*60
d24 2
a25 1
      IF (KRUN.GT.NRUMX) GO TO 999
d56 8
d103 8
d133 1
a133 1
C and the coresponding cross-section and error:
@


1.3
log
@*** empty log message ***
@
text
@d19 1
a19 1
      character chaint*4,prog*4,title*48,zkey*12,ckey*12
a187 1

@


1.2
log
@*** empty log message ***
@
text
@d37 1
a37 1
      IF (KRUN.NE.IRON) THEN
d107 1
a107 1
         CALL ALSTIN(IW(KRKSE+JRKSKW),LRKSEA-JRKSW+1,ZKEY)
d111 1
d117 1
a117 1
      xsecr=0. 
d127 1
a127 1
         CALL  ALSTIN(IW(KRKSE+JRKSKW),LRKSEA-JRKSW+1,CKEY)
d188 1
@


1.1
log
@*** empty log message ***
@
text
@d1 8
a8 7
      SUBROUTINE QRKSEC(XSEC,XSECE,NEVPR)
C-----------------------------------------------------------------------
C Writes a message with generated cross-section of current MCarlo dataset
C Called from QMNEWR
C Author J. Boucrot         25-Oct-2000
C
C-----------------------------------------------------------------------
d14 1
d17 3
a19 2
      parameter ( nrmc = 2000, ikrco = 10000, irma = 100000)
      character chaint*4,prog*4,title*48
d23 1
a26 2
C This routine is for MCarlo runs only:
      if (krun.lt.nrmc) go to 999
d28 6
d35 9
a92 1
         IF (KRUN.NE.IW(KRKSE+JRKSRN)) GO TO 200                       
d96 2
d100 1
a100 2
         IF (IGVER.NE.IW(KRKSE+JRKSGV)) GO TO 200
         IF (XMINI.AND.IMVER.NE.IW(KRKSE+JRKSMV)) GO TO 200
d102 2
a103 1
C Dataset found: give Xsec, Xsece and flag this row:
d107 3
a110 1
         GO TO 500
d112 24
a137 1
C Write the results, if needed:
d141 30
a170 2
         if (xsec.gt.0.) 
     +      write (iw(6),1234) krun,title(1:ltit),xsec,xsece,nevpr
d173 7
a179 3
     +          5x,'==> Generated cross-section =',
     +          f10.5,' pb, Error =',f10.5,/5x,
     +          '==> Total Number of events in production =',I6/
d181 1
d183 3
a185 2
c
 999  RETURN
a186 2


@

