head	1.4;
access;
symbols
	alpha126_22:1.4
	alpha126_21:1.4
	alpha126_20:1.4
	alpha126_19:1.3
	alpha126_18:1.2
	alpha126_17:1.2
	alpha126_16:1.2
	alpha126_15:1.2
	alpha126_14:1.2
	alpha126_13:1.2
	alpha126_12:1.2
	alpha126_11:1.2
	alpha126_10:1.2
	alpha126_09:1.2
	alpha126_08:1.2
	alpha126_07:1.2
	alpha126_06:1.2
	alpha126_05:1.2
	alpha126_04:1.2
	alpha126_03:1.2
	alpha126_02:1.2
	alpha126_1:1.2
	alpha125_17:1.2
	alpha125_16:1.2
	alpha125_15:1.2
	alpha125_14:1.2
	alpha125_13:1.2
	alpha125_12:1.2
	alpha125_11:1.2
	alpha125_10:1.2
	alpha125_09:1.2
	alpha125_08:1.2
	alpha125_07:1.2
	alpha125_06:1.2
	alpha125_05:1.2
	alpha125_04:1.2
	alpha125_03:1.2
	alpha125_02:1.2
	alpha125_01:1.2
	alpha124_19:1.2
	alpha125:1.2
	alpha124_18:1.2
	alpha124_17:1.2
	alpha124_16:1.2
	alpha124_15:1.2
	alpha124_14:1.2
	alpha124_13:1.2
	alpha124_12:1.2
	alpha124_11:1.2
	alpha124_10:1.2
	alpha124_09:1.2
	alpha124_08:1.2
	alpha124_07:1.2
	alpha124_7:1.2
	alpha124_06:1.2
	alpha124_05:1.2
	alpha124_04:1.2
	alpha124_03:1.2
	alpha124_02:1.2
	alpha124_01:1.2
	alpha124:1.2
	alpha123_12:1.2
	alpha123_11:1.2
	alpha123_10:1.2
	alpha123_9:1.2
	alpha123_8:1.2
	alpha123_7:1.2
	alpha123_6:1.2
	alpha123_5:1.2
	alpha123_4:1.2
	alpha123_3:1.2
	alpha123_2:1.2
	alpha123:1.2
	alpha122_48:1.2
	alpha122_47:1.2
	alpha122_46:1.2
	alpha122_45:1.2
	alpha122_44:1.2
	alpha122_43:1.1.1.1
	alpha122_42:1.1.1.1
	alpha122_41:1.1.1.1
	alpha122_40:1.1.1.1
	alpha122_39:1.1.1.1
	alpha122_38:1.1.1.1
	alpha122_37:1.1.1.1
	alpha122_36:1.1.1.1
	alpha122_35:1.1.1.1
	alpha122_34:1.1.1.1
	alpha122_33:1.1.1.1
	alpha122_32:1.1.1.1
	alpha122_31:1.1.1.1
	alpha122_30:1.1.1.1
	alpha122_29:1.1.1.1
	alpha122_28:1.1.1.1
	alpha122_27:1.1.1.1
	alpha122_26:1.1.1.1
	alpha122_25:1.1.1.1
	alpha122_24:1.1.1.1
	alpha122_23:1.1.1.1
	alpha122_22:1.1.1.1
	alpha122_21:1.1.1.1
	alpha122_20:1.1.1.1
	alpha122_19:1.1.1.1
	alpha122_18:1.1.1.1
	alpha122_17:1.1.1.1
	alpha122_16:1.1.1.1
	alpha122_15:1.1.1.1
	alpha122_14:1.1.1.1
	alpha122_13:1.1.1.1
	alpha122_12:1.1.1.1
	alpha122_11:1.1.1.1
	alpha122_10:1.1.1.1
	alpha122_9:1.1.1.1
	alpha122_8:1.1.1.1
	alpha122_6:1.1.1.1
	alpha122_5:1.1.1.1
	alpha122:1.1.1.1
	alpha212:1.1.1.1
	ALPHA212:1.1.1;
locks; strict;
comment	@c @;


1.4
date	2003.01.17.16.30.44;	author alphy;	state Exp;
branches;
next	1.3;

1.3
date	2003.01.17.12.36.45;	author alphy;	state Exp;
branches;
next	1.2;

1.2
date	98.02.09.14.23.38;	author boucrot;	state Exp;
branches;
next	1.1;

1.1
date	96.03.14.12.42.26;	author flr;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	96.03.14.12.42.27;	author flr;	state Exp;
branches;
next	;


desc
@@


1.4
log
@*** empty log message ***
@
text
@      SUBROUTINE CREFLW(IREJET)
C----------------------------------------------------------------
C! Reconstruction of the event (charged + neutral particles)
C  using :
C
C           . Charged particles
C           . Reconstructed V0's,
C           . ELectron and muon identification,
C           . Photons identified by GAMPEC,
C           . Remaining neutral hadronic energy from PCOB.
C
C  Needs PECO,PEST,EWHE,ETDI,PHCO,PPOB,PCOB,PCRL ...etc banks
C
C  Inputs:  -- Data cards to perform a preselection on charged
C              particle.
C
C  Outputs: -- irejet = 0 if bad event (not preselected, or
C                         missing bank)
C           -- Banks EFOL and EAUX
C
C  P. Janot -- 18 April 1990
C  B. Bloch -- January 2003 if absent, create empty PECO/PEST when 
C              replay on mini
C----------------------------------------------------------------
#ifndef DOC
#include "parcut.h"
#include "parabank.h"
#include "intval.h"
      CHARACTER*8 prognam
      CHARACTER*4 CHAINT
      LOGICAL first
      DATA first/.TRUE./
      DATA krun0/0/
#include "qcde.h"
#include "qmacro.h"
C----------------------------------------------------------------
C  First set the ENFLW parameters using the data cards
C
      IF ( first ) THEN
        kfwvc = 7
        CALL bkfmt('FWVC','2I,(5F,2I)')
        CALL bkfmt('EFOL','2I,(5F,6I)')
        CALL bkfmt('EJET','2I,(4F)')
        CALL bkfmt('EAUX','5I,3F')
        CALL parset
        first = .FALSE.
      ENDIF
C
      irejet = 0
      ipecow = 0
      ipestw = 0
      iefol = NLINK('EFOL',3)
C
C  Get JULIA version number + correction file
C
      IF ( krun .NE. krun0 ) THEN
        krun0 = krun
        irhah = 0
        julver = 0
        julcor = 0
        libver = 0
        narhah = NAMIND('RHAH')
        IF ( narhah .GT. 0 ) irhah = IW(narhah)
        IF ( irhah .GT. 0 ) THEN
          DO istep = 1, LROWS(irhah)
            prognam(1:4) = CHAINT(ITABL(irhah,istep,1))
            prognam(5:8) = CHAINT(ITABL(irhah,istep,2))
            IF ( prognam .EQ. 'JULIA   ' ) THEN
              julver = ITABL(irhah,istep,5)
              julcor = ITABL(irhah,istep,11)
              libver = ITABL(irhah,istep,6)
            ENDIF
          ENDDO
        ENDIF
        IF ( julver .EQ. 0 ) julver = 999
        IF ( libver .EQ. 0 ) libver = 999
        IF ( idbg .GE. 1 )
     .  WRITE (IW(6),*) 'Run ',krun,' Julia version n0 : ',julver,
     .             ' Alephlib version n0 : ',libver
      ENDIF
C
C  Create temporary banks instead of using the ALPHA QVEC area
C
      IEFOL = NBANK ('EFOL', 3, lmhlen)
      IF ( IEFOL .EQ. 0 ) THEN
        WRITE (IW(6),*)
     .  ' **** CREFLW **** Unable to create bank EFOL #3'
        GOTO 997
      ENDIF
      CALL blist(iw,'S+','EFOL')
      IW (iefol + lmhcol) = lefola
      IW (iefol + lmhlen) = 0
C
      CALL bdrop(iw,'FWVC')
      CALL vzero(ifwvc(1),7)
      nfwvc = 200
      DO ipartk = 1 , 7
        IFWVC(IPARTK) = NBANK ('FWVC', ipartk, lmhlen + kfwvc*nfwvc)
        IF ( IFWVC(IPARTK) .EQ. 0 ) THEN
          WRITE (IW(6),*)
     .    ' **** CREFLW **** Unable to create temporary banks.'
          GOTO 997
        ENDIF
        IW( ifwvc(ipartk) + lmhcol ) = kfwvc
        IW( ifwvc(ipartk) + lmhlen ) = 1
      ENDDO
C
      IF ( idbg .GE. 1 ) CALL looses('ENFLW   ',1)
C
C  Preselection on good tracks (charged particles)
C
      CALL preselfw(keep)
      IF ( keep .EQ. 0 ) GOTO 999
      IF ( idbg .GE. 1 ) CALL looses('ENFLW   ',2)
C
C  Detached vertices :
C
      CALL v0sum
C
C  Initialisation of  calorimetry
C
      ipeco = 0
      ipest = 0
      ipeco = nlink('PECO',1)
      ipest = nlink('PEST',0)
C --- start BBL mod
      if ( xmini ) then     ! if Eflow replayed on a mini, PECO/PEST needed
        IF ( ipeco .le. 0 ) then
           LEN = LMHLEN 
           CALL AUBOS('PECO',0,LEN, ipeco,IGARB)
           IW(ipeco+LMHCOL) = LPECOA
           IW(ipeco+LMHROW) = 0
           CALL AUBOS('PECO',1,LEN, ipeco,IGARB)
           IW(ipeco+LMHCOL) = LPECOA
           IW(ipeco+LMHROW) = 0
        ENDIF

        IF ( ipest .le. 0 ) then
           LEN = LMHLEN
           CALL AUBOS('PEST',0,LEN, ipest,IGARB)
           IW(ipest+LMHCOL) = LPESTA
           IW(ipest+LMHROW) = 0
        ENDIF
      ENDIF
C --- end BBL mod
      IF ( ipeco .GT. 0 ) CALL bktow(iw,'PECO',1,iw,ipecow,*10)
   10 IF ( ipest .GT. 0 ) CALL bktow(iw,'PEST',0,iw,ipestw,*11)
   11 CALL calinit(keep)
      IF ( keep .EQ. 0 ) GOTO 999
      IF ( idbg .GE. 1 ) CALL looses('ENFLW   ',3)
C
C  Electrons and muons
C
      CALL partid
C
C  Photons and neutral hadrons
C
      CALL gamixed
C
      irejet = 1
  999 CONTINUE
C
C  Build bank EFOL
C
      CALL crefol(irejet)
      IF (irejet . eq. 0 ) GO TO 998
      IF ( idbg .GE. 1 ) CALL looses('ENFLW   ',4)
C
C  Construct the bank EJET
C
      IF ( NLINK('EFLJ',0) .GT. 0 ) THEN
         CALL enfjet(irejet)
         if ( irejet . eq. 0 ) go to 998
      ENDIF
C
C  Unlock everything again
C
      CALL dlocks
C
C  Restore PECO and PEST banks from the work area
C
      IF ( ipecow .GT. 0 ) CALL bkfrw(iw,'PECO',1,iw,ipecow,*12)
   12 IF ( ipestw .GT. 0 ) CALL bkfrw(iw,'PEST',0,iw,ipestw,*13)
   13 CONTINUE
C
C  Restore the momenta of the charged particles
C
      DO jresca = 1, nresca
        factor = 1./resfac(jresca)
        itk = itkres(jresca)
        CALL qvscal(itk,factor)
      ENDDO
C
      GO TO 998
C No room for banks :
 997  irejet = 0
      CALL QWMESE(
     +'0CREFLW_ : Unable to create ENFLW banks :--> Enlarge BOS IW !!')
C drop bank EFOL , NR = 3 , if it esits , to avoid troubles in QFEFLO :
      INEF = NDROP('EFOL',3)
 998  CONTINUE
      IF ( ipecow .GT. 0 ) CALL wdrop(iw,ipecow)
      IF ( ipestw .GT. 0 ) CALL wdrop(iw,ipestw)
      RETURN
      END
#endif
@


1.3
log
@*** empty log message ***
@
text
@d129 1
a129 1
           LEN = LMHLEN + LPECOA 
d139 1
a139 1
           LEN = LMHLEN + LPESTA 
@


1.2
log
@*** empty log message ***
@
text
@d22 2
d126 20
@


1.1
log
@Initial revision
@
text
@d110 1
a110 1
      CALL presel(keep)
@


1.1.1.1
log
@import alpha122 from alws
@
text
@@
