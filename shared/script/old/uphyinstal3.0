#! /bin/csh
#====================================================================================
# 930609                                 F.Ranjard
#                       UPHYINSTAL
#====================================================================================
# uphyinstal2.0                                 FLR
# 930901 - remove reference to $HOME/.netrc,  use the existing one
#          on no MASTER machine recompile the fortran file existing on the MASTER one
# uphyinstal3.0
# 940712 - install .f on /al/${MASTER}/phy
#          use sfetch instead of ftp
#          use rsh
# ===================================================================================
#
set exec_name = "uphyinstal3.0"
set verbflr = ""
set nar = $#argv
if (${nar} != 0) then
   if ($argv[${nar}] == "-v") then
      echo "${exec_name}"
      set verflr = "-v"
      set echo on
      set argv[${nar}] = ""
      @ nar = ${nar} - 1
   endif
endif  
if (${nar} < 1) then
  echo " "
  echo "usage: " 
  echo " uphyinstal <IBM fortran filename> [<lib>]"
  echo " "
  echo " the IBM fortran file with filetype FORTRAN and filemode UPHY is"
  echo " imported using sfetch under the filename IBMfilename.fortran"
  echo " "
  echo " the existing IBM INCLUDE statments are replaced by UNIX INCLUDE statments"
  echo " and the file IBMfilename.f is created"
  echo " IBMfilename.f is compiled using the f77_options file"
  echo " a library is created with name libIBMfilename.a if the second argument is lib"

  echo " "
  echo " example"
  echo " uphyinstal obspos "
  echo " will import CERNVM: OBSPOS FORTRAN UPHY under obspos.fortran "
  echo " INCLUDE statments will be changed using getfor and obspos.f will be created"
  echo " obspos.f will be compiled to obspos.o"

  exit(1)
else
  set file = $1
  set flag = "nolib"
  if (${nar} > 1) set flag = $2
endif
#
if (${file} == "") then
  echo " uphyinstal : no file name given - exit"
  exit(1)
endif 
#
#********
#
set UNAME = `uname`
# set input and output filename for getfor
if (${UNAME} == "HP-UX") then
   set f1 = "ftn01"
   set f2 = "ftn02"
else
   set f1 = "fort.1"
   set f2 = "fort.2"
endif
#
set master_dir = "/al/${MASTER}/uphy"
set uphy_dir = "/aleph/uphy"
# 
set disk_ibm_uphy = "pubxu.204"
#  
# =========   sfetch file from cernvm
#
cd ${master_dir}
#
# remove previous files if any
if (-e {file}.fortran) rm {file}.fortran
if (-e {file}.fold) rm {file}.fold
#
sfetch ${file}.fortran -t cernvm:${file}.fortran -u ${disk_ibm_uphy} \
       -f ascii
if !(-f ${file}.fortran) then
   echo " *** sfetch FATAL error -> ${file}.fortran is not here"
   goto error_end
endif
# 
# ========   replace IBM INCLUDE statments by unix include
#            create  ${master_dir}/${file}.f
#
# keep old file.f if any as file.fold
if (-e ${file}.f) mv ${file}.f ${file}.fold
echo "run getfor to create -> ${master_dir}/${file}.f "
mv ${file}.fortran ${f1}
getfor
mv ${f2} ${file}.f
rm ${f1}
#
#
# ============ check existence of files 
#
if !(-f ${master_dir}/${file}.f) then
   echo " *** getfor FATAL error -> file ${master_dir}/${file}.f not here"
   goto error_end
endif
#
# ============================================< compile
#
compile:
cd uphy_dir
#
if (-e {file}.oold) rm {file}.oold
if (-e lib{file}.aold) rm lib{file}.aold
#
# ========= get f77 option file
set file_para = /aleph/phy/f77_options 
set all_para  = `egrep "alpha " ${file_para} | awk '{print substr($0,15)}'`
#
# ========= compile
if (${flag} == "nolib") then
echo "compile to create -> ${uphy_dir}/${file}.o "
# keep old file.o if any as file.oold
   if (-e ${file}.o) mv ${file}.o ${file}.oold
# compile the full file and keep the .o
   f77 ${all_para} ${master_dir}/${file}.f
   if !(-f ${file}.o) then
      echo "*** FATAL compilation errors -> ${file}.o is not there"
      goto error_end
   endif
else   
#
# create a temporary directory
# move file to this temp dir
# fnice and fsplit    
   set tmp_dir = ${uphy_dir}/${file}.srctmp
   mkdir ${tmp_dir}
   cd ${tmp_dir}
   cp ${master_dir}/${file}.f tmp.f
   fnice tmp.f
   fsplit tmp.f
   rm tmp.*
#
   echo "compile and  create -> ${uphy_dir}/lib${file}.a "
# compile all .f
   f77 ${all_para} *.f | & tee -a compile.log
# check compile.log for 'ERROR'
   grep -n 'ERROR' compile.log > error.log
   grep -n 'Error' compile.log >> error.log
   if !(-z error.log) then
      echo " FATAL error(s) during compilation, look at "
      echo "       ${tmp_dir}/compile.log file"
      goto error_end
   endif 
# make a library in the upper directory
   if (-e ../lib${file}.a) mv ../lib${file}.a ../lib${file}.aold
   ar rls ../lib${file}.a *.o
# release temp directory
   rm *
   cd ..
   rmdir ${tmp_dir}
endif
# ==========================================> normal exit
#  remove temporary files
#
# ============================
cd ${uphy_dir}
rm -f ftp_tmp
rm -f ${file}.fortran
rm -f ${file}.fold
rm -f ${file}.oold
#
echo "uphyinstal normal exit"
exit
#=============================================> abnormal exit
error_end:
echo "uphyinstal abnormal exit - restore previous files if any "
cd ${uphy_dir}
if (-e ${file}.oold) mv ${file}.oold ${file}.o
if (-e lib${file}.aold) mv lib${file}.aold lib${file}.a
cd ${master_dir}
if (-e ${file}.fold) mv ${file}.fold ${file}.f
exit
 
 











