#!/bin/sh
#
# stage tape in for ALEPH
#
#       @(#)stagein	1.5 10/8/91 CERN CN-SW/DC Les Robertson
#       @(#)alstagein	3.0 11/3/93 CERN ALEPH Joel Closier
#       @(#)alstagein	5.0 28/4/94 CERN ALEPH Joel Closier for Baud stager
#       @(#)alstagein	5.1  3/5/94 CERN ALEPH Uli Schafer "exit 0" removed
#                                              stageqry used instead 
#       @(#)alstagein	5.2  3/5/94 CERN ALEPH Uli Schafer remote access ALWS
#       @(#)alstagein	5.3  8/8/94 CERN ALEPH Ronald Hagelberg  Year for Log
#       @(#)alstagein	5.4 23/1/95 mod. to adapt to new stageqry
#
#  Copyright (C) 1992,1993 by ALEPH
#  All rights reserved
#
########
# First special version for Aleph (if environment variable are not defined)
#	Defaults to     -p alephdata
#			-F F -b 32040
#			-u aleph
#			-s 200
#                       -link /aleph/data
#		  filename VID.fseq.label
#		  fileprot -rwxrwxr-x       
#			-l sl -q 1
########
#
# calling seqence:
#
# stagein 
#   {tpread/tpwrite parameters}
#         -v VSN [-V VID] [-g {CART|TAPE|SMCF}] [-l {sl|nl|al|blp}]
#         [-d {6250|1600}] [-q sequence] [-f fileid] [-F record-format]
#         [-L record-length] [-b block-size] [-N block-count] [-G]
#         [-t retention-period] [-S server]
#   {sfget parameters}
#         [-p pool] [-u user] [-s size] [-r] [-link pathname] filename
#   {assign parameter}
#         [-U fun]
#
#    {other parameters}
#         [ -x ]  debug mode
#         [ -K ]  for Cray compatibility      (ignored)
#
#
#          
###############################################################################
#
# set defaults, initialise variables
#
CMD="alstagein"
CMD_STAGE="/usr/local/bin/stagein"
CMD_QRY="/usr/local/bin/stageqry"
ALWS_DEV='alws:al$data'
VER="5.7"
VSNVID=FALSE
FILENAME=""
NODE=`uname -n`
FILELOG="/aleph/log/stagein.log"
#FILELOG="/u/xu/closier/dev/stagein.log"
#
###############################################################################
#
#                  functions
#
###############################################################################
#
usage()
{
  echo "usage: $CMD [-v VSN] [-V VID] [-g {CART|TAPE|SMCF}] [-l {sl|nl|al|blp}]" 1>&2
  echo "       [-d {6250|1600}] [-q sequence] [-f fileid] [-F record-format]" 1>&2
  echo "       [-L record-length] [-b block-size] [-N block-count] [-G]" 1>&2
  echo "       [-t retention-period] [-S server]" 1>&2
  echo "       [-p pool] [-u user] [-s size] [-r] [-link pathname]" 1>&2
  echo "       [-U fun]" 1>&2
  echo "       filename" 1>&2
  exit 5
}
###############################################################################
#
#
#
# STAGE defaults for ALEPH if does not exist
#
STAGELABEL=${STAGELABEL:-"sl"}
STAGEFSEQ=${STAGEFSEQ:-"1"}
STAGERECFM=${STAGERECFM:-"F"}
STAGELRECL=${STAGELRECL:-"32040"}
STAGEBLKSIZ=${STAGEBLKSIZ:-"32040"}
STAGE_USER=${STAGE_USER:-"aleph"}
STAGECLEAN=${STAGECLEAN:-"/aleph/script/stage_clean"}
#
#  DPM defaults for ALEPH
#
DPMPOOL=${DPMPOOL:-"alephdata"}
DPMUSER=${DPMUSER:-"aleph"}
DPMSIZE=${DPMSIZE:-"200"}
DPMLINKDIR=${DPMLINKDIR:-"/aleph/data"}

para=""
parm=""
while [ $# -gt 0 ]
do
  case $1 in
  -link) DPMLINKDIR="$2" ; shift ;; 
      *) para="$para $1";;
  esac
  shift
done
# parse parameters
#
set -- `getopt xrGKv:V:g:l:d:q:f:F:L:b:N:t:S:p:u:s:U: $para`
#
while [ $# -gt 0 ]
do
  case $1 in
  -x) set -x ;;
  -r) parm="$parm $1"  ;;
  -G) parm="$parm $1"  ;;
  -K) parm="$parm $1" ;;
  --) ;;
  -?)
#     remaining options require a value
      if [ $# -lt 2 ]
        then
          usage
      fi
      case $1 in 
#     look for a tpread/tpwrite parameters
      -v)  VSNVID=TRUE
           ALEPHFILENAME=$2
           ALEPHFILENAME=`echo $ALEPHFILENAME | tr "[A-Z]" "[a-z]"`
	   parm="$parm $1 $2" ; shift ;; 
      -V)  VSNVID=TRUE
           ALEPHFILENAME=$2
           ALEPHFILENAME=`echo $ALEPHFILENAME | tr "[A-Z]" "[a-z]"`
	   parm="$parm $1 $2" ; shift ;; 
      -l)  STAGELABEL="$2" ; shift ;; 
      -g)  tmpparm="$1 $2" ; shift ;;
      -q)  STAGEFSEQ="$2" ; shift ;; 
      -f)  parm="$parm $1 $2" ; shift ;; 
      -F)  STAGERECFM="$2" ; shift ;; 
      -b)  STAGEBLKSIZ="$2" ; shift ;; 
      -L)  STAGELRECL="$2" ; shift ;; 
#     and now POOL parameters
      -p)  DPMPOOL="$2" ; shift ;; 
      -s)  DPMSIZE="$2" ; shift ;; 
      -u)  DPMUSER="$2"
           STAGE_USER="$2" ; shift ;; 
      -?)  parm="$parm $1 $2" ; shift ;; 
      *)   parm="$parm $1 $2" ;;
      esac
      ;;
# must be the filename
  *)
       if [ "$FILENAME" != "" ]
         then
           usage
       fi
       FILENAME=$1
       ;;
  esac
  shift
done
#
if [ -z "$FILENAME" ]
  then
       FILENAME="$ALEPHFILENAME.$STAGEFSEQ.$STAGELABEL"
  fi
if [ -z "$FILENAME" -o "$VSNVID" = "FALSE" ]
  then
    echo $CMD: "{vsn or vid} and filename required" 1>&2
    usage
fi
#
#
STAGEFLAG="-b $STAGEBLKSIZ -F $STAGERECFM -L $STAGELRECL -l $STAGELABEL -q $STAGEFSEQ"
DPMFLAG="-p $DPMPOOL -u $STAGE_USER -s $DPMSIZE"
locallink=`echo $DPMLINKDIR | awk -F: '{print $2}'`
linkexist=`ls $locallink/$FILENAME > /dev/null 2>&1`
linkexisterr=$?
if [ $linkexisterr -ne 0 ]
then
  tms=`sysreq tms q v $ALEPHFILENAME`
  tmserr=$?
  if [ $tmserr -eq 1 ]
    then
      parm="$parm $tmpparm" 
  fi
fi
ERR=-1
ERRC=1 
USE=`id | cut -f2 -d"(" | cut -f1 -d")"`
DATE=`date`
#DATEA=`echo $DATE | awk '{print $6}'`
DATEA=`date "+%Y"`
DATEB=`echo $DATE | awk '{print $2}'`
DATEC=`echo $DATE | awk '{print $3}'`
DATEC=`expr ${DATEC} + 0`
DATED=`echo $DATE | awk '{print $4}'`
DATE=`echo $DATEA $DATEB $DATEC $DATED`

STAGE_FNM=`echo $ALEPHFILENAME |tr "[a-z]" "[A-Z]"`
STAGE_FNM="$STAGE_FNM.$STAGEFSEQ.$STAGELABEL"

# check on availability on ALWS, -q u doesn't work except AA tapes on alws only
$CMD_QRY -P -V $ALEPHFILENAME | grep "/$STAGE_FNM" >/dev/null && ERRC=0
#if [ \( $? != 0 \) -a \( "$STAGEFSEQ" != "u" \) -a \( "$HOST" = "shift9" \) ]
if [ \( $? != 0 \) -a \( "$STAGEFSEQ" != "u" \) ]
  then
  ALWS_FNM="$ALWS_DEV:${ALEPHFILENAME}_$STAGEFSEQ.$STAGELABEL"
  rfstat $ALWS_FNM > /dev/null 2>&1 && ln -sf $ALWS_FNM $DPMLINKDIR/$FILENAME \
   && ERRC=2 
  ERR=$?
  if [ $ERR -ne 0 ]
  then
     ERR=`expr $ERR + 500`
  fi
fi 
if [ $ERRC -lt 2 ] 
then
  $CMD_STAGE $parm $STAGEFLAG $DPMFLAG $DPMLINKDIR/$FILENAME 
  ERR=$? 
fi   

#  write a log file for statistics
DATE2=`echo $DATE | awk '{print $4}'`
DATE1=`date`
DATE1=`echo $DATE1 | awk '{print $4}'`
DAYTIME=86400
h1=`echo $DATE2 | awk -F: '{print $1}'`
m1=`echo $DATE2 | awk -F: '{print $2}'`
s1=`echo $DATE2 | awk -F: '{print $3}'`
h1=`expr ${h1} \* 3600`
m1=`expr ${m1} \* 60`
SDATE=`expr ${h1} + ${m1} + ${s1}`
h2=`echo $DATE1 | awk -F: '{print $1}'`
m2=`echo $DATE1 | awk -F: '{print $2}'`
s2=`echo $DATE1 | awk -F: '{print $3}'`
h2=`expr ${h2} \* 3600`
m2=`expr ${m2} \* 60`
SDATE1=`expr ${h2} + ${m2} + ${s2}`
ELAPSED=`expr ${SDATE1} - ${SDATE}`
if [ $SDATE1 -lt $SDATE ]
  then
    ELAPSED=`expr ${DAYTIME} + ${ELAPSED}`
fi
he=`expr ${ELAPSED} / 3600 | awk -F. '{print $1}'`
me=`expr ${ELAPSED} - 3600 \* ${he}`
me=`expr ${me} / 60 | awk -F. '{print $1}'`
se=`expr ${ELAPSED} - 3600 \* ${he} - 60 \* ${me}`

echo "$DATE $he:$me:$se $USE $FILENAME rc=($ERRC $ERR) $VER $NODE">> $FILELOG
exit $ERR
