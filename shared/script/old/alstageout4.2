#!/bin/sh
#
# stage tape out
#       
#       @(#)stageout	1.8  10/8/91  CERN CN-SW/DC Les Robertson
#
#  Copyright (C) 1990,1991 by CERN/CN/SW/DC
#  All rights reserved
#
# First special version for Aleph
#
#	Defaults to 	-p alephdata
#		    	-F F -b 32040
#		    	-f ALDATA
#		    	-u aleph
#                       -link /aleph/data
#		 filename VID.LABEL.FSEQ
#		  fileprot -rwxrwxr-x       
#			-l sl -q 1
#
#
# calling seqence:
#
# stageout 
#   {tpwrite parameters}
#         -v VSN [-V VID] [-g {CART|TAPE|SMCF}] [-l {sl|nl|al|blp}]
#         [-d {6250|1600}] [-q sequence] [-f fileid] [-F record-format]
#         [-L record-length] [-b block-size] [-N block-count] [-G]
#         [-t retention-period] [-S server]
#   {sfget parameters}
#         [-p pool] [-u user] [-s size] [-r] [-link pathname] filename
#   {assign parameter}
#         [-U fun]
#
#    {other parameters}
#         [ -x ]  debug mode
#         [ -K ]  for Cray compatibility      (ignored)
#         [ -S sbin ] for Cray compatibility  (ignored)
#
####
#
# Modifications: 
#  26aug91: Clean up; add -G, -t, -S options
# 09sep91: Default user taken from environment variable STAGE_USER
# 30 oct 92 : add -link option for sfget    JC
#
# JC 14-12-93 : log file in /aleph/log
#   4.0
# JC 15-02-94 : -link = no then we do not use the LINK options
#   4.1
###############################################################################
#
#
# set defaults, initialise variables
#
VER="4.2"
CMD="stageout"
FILELOG="/aleph/log/stageout.log"
#FILELOG="/u/xu/closier/dev/stageout.log"
REMOVE=TRUE
VSNVID=FALSE
FILENAME=""
NODE=`uname -n`
ALEPHPARM=""
ALEPHSFGETPARM=""
if [ "x$STAGE_USER" != "x" ]
  then
    USER="-u $STAGE_USER"
  else
    USER=""
fi
#
###############################################################################
#
#                  functions
#
###############################################################################
#
usage()
{
  echo "usage: $CMD [-v VSN] [-V VID] [-g {CART|TAPE|SMCF}] [-l {sl|nl|al|blp}]" 1>&2
  echo "       [-d {6250|1600}] [-q sequence] [-f fileid] [-F record-format]" 1>&2
  echo "       [-L record-length] [-b block-size] [-N block-count] [-G]" 1>&2
  echo "       [-t retention-period] [-S server]" 1>&2
  echo "       [-p pool] [-u user] [-s size] [-r] [-link pathname]" 1>&2
  echo "       [-U fun]" 1>&2
  echo "       filename" 1>&2
  exit 5
}
###############################################################################
#
#
#---------------------------------
para=""
LINKDIR="yes"
parm=""
optlink=""
while [ $# -gt 0 ]
do
  case $1 in
  -link)  if [ $2 != no -o $2 != NO ]
             then
                ALEPHLINKDIR="$1 $2"
             else 
                ALEPHLINKDIR=""
                DPMLINKDIR=""
                LINKDIR="$2"
          fi
          shift
          ;;
  *) para="$para $1"
      ;;
  esac
  shift
done
#
# parse parameters
#
set -- `getopt xrGKv:V:g:l:d:q:f:F:L:b:N:t:S:p:u:s:U: $para`
#
while [ $# -gt 0 ]
do
  case $1 in
  -x) set -x ; parm="$parm $1";;
  -G) parm="$parm $1" ;;
  -r) parm="$parm $1" ;;
  -K) REMOVE=FALSE; parm="$parm $1";;
  --) ;;
  -?)
#     remaining options require a value
      if [ $# -lt 2 ]
        then
          usage
      fi
      case $1 in 
#     look for a tpread/tpwrite parameters
      -v)  VSNVID=TRUE
	   ALEPHFILENAME=$2
           ALEPHFILENAME=`echo $ALEPHFILENAME | tr "[A-Z]" "[a-z]"`
           ALEPHPARM="$ALEPHPARM $1 $2"
           shift
           ;;
      -V)  VSNVID=TRUE
	   ALEPHFILENAME=$2
           ALEPHFILENAME=`echo $ALEPHFILENAME | tr "[A-Z]" "[a-z]"`
           ALEPHPARM="$ALEPHPARM $1 $2"
           shift
           ;;
      -l)  ALEPHLABEL="$2"
           ALEPHPARM="$ALEPHPARM $1 $2"
           shift
           ;;
      -q)  ALEPHFSEQ="$2"
           ALEPHPARM="$ALEPHPARM $1 $2"
           shift
           ;;
      -f)  ALEPHFID="$1 $2"
           ALEPHPARM="$ALEPHPARM $1 $2"
           shift
           ;;
      -F)  ALEPHRECFM="$1 $2"
           ALEPHPARM="$ALEPHPARM $1 $2"
           shift
           ;;
      -b)  ALEPHBLKSIZ="$1 $2"
           ALEPHPARM="$ALEPHPARM $1 $2"
           shift
           ;;
#     and now sfget parameters
      -p)  ALEPHPOOLNAME="$1 $2"	
           ALEPHSFGETPARM="$ALEPHSFGETPARM $1 $2"
           shift
           ;;
      -u)  USER="$1 $2"
           ALEPHSFGETPARM="$ALEPHSFGETPARM $1 $2"
           shift
           ;;
      -?)  parm="$parm $1 $2" 
           shift
           ;;
      *)   parm="$parm $1 $2" ;;
      esac
      ;;
# must be the filename
  *)
       if [ "$FILENAME" != "" ]
         then
           usage
       fi
       FILENAME=$1
       ;;
  esac
  shift
done
#
# parameters parsed - check that a vsn and filename were supplied
if [ -z "$ALEPHLABEL" ]
  then
       ALEPHLABEL="sl"
       ALEPHPARM="$ALEPHPARM -l sl"
  fi
if [ -z "$ALEPHFSEQ" ]
  then
	ALEPHFSEQ="1"
        ALEPHPARM="$ALEPHPARM -q 1"
  fi
if [ -z "$ALEPHFID" ]
  then 
	ALEPHPARM="$ALEPHPARM -f ALDATA"
  fi
if [ -z "$ALEPHRECFM" ]
  then
	ALEPHPARM="$ALEPHPARM -F F -L 32040"
  fi
if [ -z "$ALEPHBLKSIZ" ]
  then
	ALEPHPARM="$ALEPHPARM -b 32040"
  fi
if [ -z "$USER" ]
  then
	ALEPHSFGETPARM="$ALEPHSFGETPARM -u aleph"
  fi
if [ -z "$ALEPHPOOLNAME" ]
  then
	ALEPHSFGETPARM="$ALEPHSFGETPARM -p $ALSTOUT"
  fi
if [ -z "$ALEPHLINKDIR" ]
  then
        if [ "$LINKDIR" = "yes" ]
           then
 	       ALEPHLINKDIR="-link /aleph/data"
        fi
  fi
if [ -z "$FILENAME" ]
  then
       FILENAME="$ALEPHFILENAME.$ALEPHFSEQ.$ALEPHLABEL"
  fi
if [ -z "$FILENAME" -o "$VSNVID" = "FALSE" ]
  then
    echo $CMD: "{vsn or vid} and filename required" 1>&2
    usage
fi
#
#
STAGESTAT1=-1
STAGESTAT2=-1
STAGESTAT3=-1
STAGESTAT4=0
USE=`id | cut -f2 -d"(" | cut -f1 -d")"`
DATE=`date`
DATE=`echo $DATE | awk '{print $6,$2,$3,$4}'`

/usr/local/bin/DPMstageout $parm $ALEPHPARM $ALEPHSFGETPARM $FILENAME
STAGESTAT1=$?
if [ "$STAGESTAT1" = 0 ]
  then
     if [ "$REMOVE" = "TRUE" ]
        then
          echo alstageout succeded and $FILENAME will be removed
          sfrm $ALEPHSFGETPARM $ALEPHLINKDIR $FILENAME
        else
          sfget $ALEPHPOOLNAME $USER $ALEPHLINKDIR $FILENAME
     fi
  else
    sleep 120
    /usr/local/bin/DPMstageout $parm $ALEPHPARM $ALEPHSFGETPARM $FILENAME
    STAGESTAT2=$?
    if [ "$STAGESTAT2" = 0 ] 
      then
        if [ "$REMOVE" = "TRUE" ]
           then
             echo alstageout succeded and $FILENAME will be removed
             sfrm $ALEPHSFGETPARM $ALEPHLINKDIR $FILENAME
           else
             sfget $ALEPHPOOLNAME $USER $ALEPHLINKDIR $FILENAME
        fi
     else
        sleep 120
        /usr/local/bin/DPMstageout $parm $ALEPHPARM $ALEPHSFGETPARM $FILENAME
        STAGESTAT3=$?
        if [ "$STAGESTAT3" = 0 ] 
          then
            if [ "$REMOVE" = "TRUE" ]
              then
                echo alstageout succeded and $FILENAME will be removed
                sfrm $ALEPHSFGETPARM $ALEPHLINKDIR $FILENAME
              else
                sfget $ALEPHPOOLNAME $USER $ALEPHLINKDIR $FILENAME
            fi
        else
          sleep 120
          /usr/local/bin/DPMstageout $parm $ALEPHPARM $ALEPHSFGETPARM $FILENAME
          STAGESTAT4=$?
          if [ "$STAGESTAT4" = 0 ] 
             then
              if [ "$REMOVE" = "TRUE" ]
                 then
                   echo alstageout succeded and $FILENAME will be removed
                   sfrm $ALEPHSFGETPARM $ALEPHLINKDIR $FILENAME
                 else
                   sfget $ALEPHPOOLNAME $USER $ALEPHLINKDIR $FILENAME
              fi
           fi
        fi
    fi
fi


DATE2=`echo $DATE | awk '{print $4}'`
DATE1=`date`
DATE1=`echo $DATE1 | awk '{print $4}'`
DAYTIME=86400
h1=`echo $DATE2 | awk -F: '{print $1}'`
m1=`echo $DATE2 | awk -F: '{print $2}'`
s1=`echo $DATE2 | awk -F: '{print $3}'`
h1=`expr ${h1} \* 3600`
m1=`expr ${m1} \* 60`
SDATE=`expr ${h1} + ${m1} + ${s1}`
h2=`echo $DATE1 | awk -F: '{print $1}'`
m2=`echo $DATE1 | awk -F: '{print $2}'`
s2=`echo $DATE1 | awk -F: '{print $3}'`
h2=`expr ${h2} \* 3600`
m2=`expr ${m2} \* 60`
SDATE1=`expr ${h2} + ${m2} + ${s2}`
ELAPSED=`expr ${SDATE1} - ${SDATE}`
if [ $SDATE1 -lt $SDATE ]
  then
    ELAPSED=`expr ${DAYTIME} + ${ELAPSED}`
fi
he=`expr ${ELAPSED} / 3600 | awk -F. '{print $1}'`
me=`expr ${ELAPSED} - 3600 \* ${he}`
me=`expr ${me} / 60 | awk -F. '{print $1}'`
se=`expr ${ELAPSED} - 3600 \* ${he} - 60 \* ${me}`
echo "$DATE $he:$me:$se $USE $FILENAME rc=($STAGESTAT1 $STAGESTAT2 $STAGESTAT3 $STAGESTAT4) $VER $NODE">> $FILELOG
exit $STAGESTAT4







