#!/bin/csh
#-----------------------------------------------------------------------
# Script : purge_nqs_dir
# Devel. : j. Closier
# Date   : 20 April 1994
# Goals  : Clean the temporary NQS directory (/aleph/tmp/nqs on OSF1
#          and /usr/tmp/nqs on IRIX
# Usage  : purge_nqs_dir
# Modify : 26 Jan 1995 . If january, then check for the previous year
#-----------------------------------------------------------------------
#
#set echo on
set FILE_IN="/aleph/tmp/filein.txt"
set FILE_LOG="/aleph/log/purge.log"
set MONTH=`date | awk '{print $2}'`
set DAY=`date | awk '{print $3}'`
set DELAY="4"

echo "***  Purge start `date`  ***" >> $FILE_LOG
goto CALCUL

REMOVE:
ls -ltd /usr/tmp/nqs/* > $FILE_IN
set nb_lines=`cat $FILE_IN | wc -l`
set nb_day1=$nb_day
while ($nb_lines != 0)
  set line=`head -$nb_lines $FILE_IN | tail -1`
  set l_month=`echo $line | awk '{print $6}'`
  set l_day=`echo $line | awk '{print $7}'`
  set filename=`echo $line | awk '{print $9}'`
  set nb_day=0
  switch($l_month)
  case Jan: 
            set nb_day=0
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Feb: 
            set nb_day=31
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Mar: 
            set nb_day=59
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Apr: 
            set nb_day=90
            set nb_day=`expr ${nb_day} + ${l_day}`
            breaksw 
  case May: 
            set nb_day=120
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Jun: 
            set nb_day=151
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Jul: 
            set nb_day=181
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Aug: 
            set nb_day=212
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Sep: 
            set nb_day=243
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Oct: 
            set nb_day=273
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Nov: 
            set nb_day=304
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Dec: 
            set nb_day=334
            set nb_day = `expr ${nb_day} + ${l_day}`
            if ($MONTH == Jan) set nb_day = `expr ${nb_day} - 365`
            breaksw 
  endsw

  @ nb_lines--
  set diff_day=`expr ${nb_day1} - ${nb_day}`
  if ($diff_day >= $DELAY) then
     echo "$line" >> $FILE_LOG
     rm -rf $filename
  endif
  continue
end
rm -f $FILE_IN

ls -ltd /al/OSF1/tmp/nqs/* > $FILE_IN
set nb_lines=`cat $FILE_IN | wc -l`
set nb_day1=$nb_day
while ($nb_lines != 0)
  set line=`head -$nb_lines $FILE_IN | tail -1`
  set l_month=`echo $line | awk '{print $6}'`
  set l_day=`echo $line | awk '{print $7}'`
  set filename=`echo $line | awk '{print $9}'`
  set nb_day=0
  switch($l_month)
  case Jan: 
            set nb_day=0
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Feb: 
            set nb_day=31
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Mar: 
            set nb_day=59
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Apr: 
            set nb_day=90
            set nb_day=`expr ${nb_day} + ${l_day}`
            breaksw 
  case May: 
            set nb_day=120
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Jun: 
            set nb_day=151
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Jul: 
            set nb_day=181
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Aug: 
            set nb_day=212
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Sep: 
            set nb_day=243
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Oct: 
            set nb_day=273
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Nov: 
            set nb_day=304
            set nb_day = `expr ${nb_day} + ${l_day}`
            breaksw 
  case Dec: 
            set nb_day=334
            set nb_day = `expr ${nb_day} + ${l_day}`
            if ($MONTH == Jan) set nb_day = `expr ${nb_day} - 365`
            breaksw 
  endsw

  @ nb_lines--
  set diff_day=`expr ${nb_day1} - ${nb_day}`
  if ($diff_day >= $DELAY) then
     echo "$line" >> $FILE_LOG
     rm -rf $filename
  endif
  continue
end
rm -f $FILE_IN
exit 0

CALCUL:
switch($MONTH)
  case Jan: 
            set nb_day=0
            set nb_day = `expr ${nb_day} + ${DAY}`
            breaksw 
  case Feb: 
            set nb_day=31
            set nb_day = `expr ${nb_day} + ${DAY}`
            breaksw 
  case Mar: 
            set nb_day=59
            set nb_day = `expr ${nb_day} + ${DAY}`
            breaksw 
  case Apr: 
            set nb_day=90
            set nb_day=`expr ${nb_day} + ${DAY}`
            breaksw 
  case May: 
            set nb_day=120
            set nb_day = `expr ${nb_day} + ${DAY}`
            breaksw 
  case Jun: 
            set nb_day=151
            set nb_day = `expr ${nb_day} + ${DAY}`
            breaksw 
  case Jul: 
            set nb_day=181
            set nb_day = `expr ${nb_day} + ${DAY}`
            breaksw 
  case Aug: 
            set nb_day=212
            set nb_day = `expr ${nb_day} + ${DAY}`
            breaksw 
  case Sep: 
            set nb_day=243
            set nb_day = `expr ${nb_day} + ${DAY}`
            breaksw 
  case Oct: 
            set nb_day=273
            set nb_day = `expr ${nb_day} + ${DAY}`
            breaksw 
  case Nov: 
            set nb_day=304
            set nb_day = `expr ${nb_day} + ${DAY}`
            breaksw 
  case Dec: 
            set nb_day=334
            set nb_day = `expr ${nb_day} + ${DAY}`
            breaksw 
endsw
goto REMOVE
